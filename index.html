<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDAL TRADER - Plataforma Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Montserrat:wght@400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,300&family=Playfair+Display:wght@700;900&family=Press+Start+2P&display=swap');
        
        :root { --udal-blue: #002855; --udal-red: #a51c30; --paper-bg: #fdfbf7; }

        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        .retro-font { font-family: 'Roboto Mono', monospace; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .serif-font { font-family: 'Merriweather', serif; }
        .headline-font { font-family: 'Playfair Display', serif; }
        
        .card { background-color: white; border-top: 4px solid var(--udal-blue); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .btn-udal { background-color: var(--udal-blue); color: white; transition: all 0.2s; }
        .btn-udal:hover { background-color: #0f172a; transform: translateY(-1px); }
        .btn-danger { background-color: var(--udal-red); color: white; }
        .btn-danger:hover { background-color: #7f1d1d; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .newspaper { background-color: var(--paper-bg); border: 1px solid #d1d5db; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); position: relative; }
        .newspaper::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--udal-blue) 0%, var(--udal-red) 100%); }

        /* Tooltips siempre activos */
        .help-icon { cursor: help; color: var(--udal-blue); margin-left: 5px; opacity: 0.8; display: inline-block; }
        .help-icon:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 8px 10px; border-radius: 4px; font-size: 10px; font-family: sans-serif;
            width: 180px; text-align: center; z-index: 9999; pointer-events: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); line-height: 1.3; white-space: normal;
        }
        .relative-tip { position: relative; }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .btn-opportunity { animation: pulse-gold 2s infinite; }

        .oregon-modal { background-color: #000; color: #33ff00; font-family: 'Press Start 2P', monospace; border: 4px double #33ff00; text-transform: uppercase; }
        .oregon-btn { border: 2px solid #33ff00; color: #33ff00; background: transparent; padding: 10px; cursor: pointer; transition: all 0.2s; font-size: 10px; }
        .oregon-btn:hover { background: #33ff00; color: #000; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-between relative bg-gray-50">

    <header class="w-full bg-white shadow-md z-10 relative">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center bg-white border-2 border-blue-900 w-16 h-10 rounded shadow overflow-hidden">
                    <span class="text-blue-900 font-black text-lg tracking-tighter">UDAL</span>
                </div>
                <div><h1 class="text-xl md:text-2xl font-bold text-blue-900 tracking-tighter">SIMULADOR <span class="text-red-800">DE MERCADOS</span></h1></div>
            </div>
            <button onclick="showTeacherLogin()" class="text-xs text-gray-400 hover:text-blue-900 transition-colors"><i class="fas fa-lock"></i> Acceso Docente</button>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center p-4 relative w-full max-w-7xl mx-auto">
        
        <!-- LOGIN -->
        <section id="loginSection" class="w-full max-w-lg card p-8 mb-4 fade-in mt-8 relative">
            <div class="absolute -top-3 -right-3 bg-red-800 text-white text-[10px] font-bold px-2 py-1 rounded shadow transform rotate-6">v2.0 FINAL</div>
            <h2 class="text-xl font-bold mb-2 text-center text-blue-900">Acceso Estudiantes</h2>
            
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="toggleLoginMode('new')" id="tabNew" class="flex-1 py-2 text-blue-900 border-b-2 border-blue-900 font-bold text-sm">Nuevo Portafolio</button>
                <button onclick="toggleLoginMode('load')" id="tabLoad" class="flex-1 py-2 text-gray-400 text-sm hover:text-gray-600">Continuar Inversiones</button>
            </div>

            <div id="newGameForm">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Matr√≠cula (9 D√≠gitos)</label>
                <input type="number" id="studentId" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-6 text-gray-800 focus:outline-none focus:border-blue-900 font-mono tracking-widest" placeholder="Ej. 100017415">
                <button onclick="startSequence()" class="w-full btn-udal font-bold py-3 rounded shadow-lg">VALIDAR Y ACCEDER</button>
            </div>

            <div id="loadGameForm" class="hidden">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Token de Acceso</label>
                <textarea id="saveCodeInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-2 text-blue-900 retro-font text-xs h-24 focus:outline-none focus:border-blue-900" placeholder="Pega aqu√≠ tu token..."></textarea>
                <button onclick="loadGame()" class="w-full btn-danger font-bold py-3 rounded shadow-lg">RESTAURAR SESI√ìN</button>
            </div>
        </section>

        <!-- GAME -->
        <section id="gameSection" class="w-full hidden fade-in">
            <div class="flex justify-between items-end mb-4 border-b border-gray-200 pb-2">
                <div><p class="text-[10px] text-gray-400 uppercase">Operador</p><h2 class="text-sm font-bold text-blue-900" id="operatorNameDisplay">...</h2></div>
                <div class="text-right"><p class="text-[10px] text-gray-400">Matr√≠cula</p><p class="text-sm font-mono text-gray-600" id="operatorIdDisplay">...</p></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-900 relative relative-tip">
                    <div class="flex justify-between items-center mb-1"><p class="text-[10px] text-gray-500 uppercase font-bold">Jornada</p><i class="fas fa-question-circle help-icon" data-tip="D√≠a actual (1 a 7)."></i></div>
                    <p class="text-2xl font-bold retro-font text-blue-900" id="displayDay">D√≠a 1 / 7</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-600 relative relative-tip">
                    <div class="flex justify-between items-center mb-1"><p class="text-[10px] text-gray-500 uppercase font-bold">Liquidez</p><i class="fas fa-question-circle help-icon" data-tip="Dinero disponible para gastar."></i></div>
                    <p class="text-xl font-bold retro-font text-green-700" id="displayCash">$1,000,000</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-purple-600 relative relative-tip">
                    <div class="flex justify-between items-center mb-1"><p class="text-[10px] text-gray-500 uppercase font-bold">Inversiones</p><i class="fas fa-question-circle help-icon" data-tip="Valor de tus activos hoy."></i></div>
                    <p class="text-xl font-bold retro-font text-purple-700" id="displayPortfolioVal">$0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-gray-800 relative relative-tip">
                    <div class="flex justify-between items-center mb-1"><p class="text-[10px] text-gray-500 uppercase font-bold">Patrimonio</p><i class="fas fa-question-circle help-icon" data-tip="Dinero + Activos - Deudas."></i></div>
                    <p class="text-xl font-bold retro-font text-gray-800" id="displayNetWorth">$1,000,000</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 flex flex-col gap-4">
                    <div id="newsSection" class="newspaper p-5 rounded relative">
                        <div class="border-b-2 border-black mb-3 pb-2 flex justify-between items-end">
                            <h3 class="headline-font font-black text-xl text-black leading-none" id="newsTitle">EL FINANCIERO</h3>
                            <button onclick="toggleNewsSource()" class="text-[10px] border border-gray-400 px-2 py-1 rounded hover:bg-white">Fuente ‚Üª</button>
                        </div>
                        <div id="newsFeed" class="space-y-4"></div>
                    </div>

                    <div class="bg-white border-t-4 border-gray-800 p-4 rounded shadow relative">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-sm"><i class="fas fa-briefcase"></i> Opciones</h3>
                        
                        <div class="mb-3">
                            <button onclick="openExpertModal()" id="btnExpert" class="w-full py-2 rounded font-bold text-xs shadow flex justify-between items-center px-3 bg-gray-100 hover:bg-gray-200 text-gray-700">
                                <span><i class="fas fa-user-tie"></i> Consultar Analista</span>
                                <span class="text-[9px] bg-gray-300 px-1 rounded" id="expertCostBadge">$5k</span>
                            </button>
                        </div>
                        <div class="mb-3">
                            <button onclick="openLoanModal()" id="btnLoan" class="w-full py-2 rounded font-bold text-xs shadow flex justify-between items-center px-3 bg-gray-100 hover:bg-gray-200 text-gray-700">
                                <span><i class="fas fa-landmark"></i> Solicitar Cr√©dito</span><span class="text-[9px] bg-gray-300 px-1 rounded">√önico</span>
                            </button>
                            <div id="loanStatus" class="hidden flex justify-between items-center text-[10px] bg-red-50 text-red-800 p-2 rounded border border-red-100 mt-1 font-bold">
                                <span><i class="fas fa-check-circle"></i> Deuda Activa</span><button onclick="payLoan()" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-[9px]">LIQUIDAR</button>
                            </div>
                        </div>
                        <div>
                            <button onclick="openHustleModal()" id="btnHustle" class="w-full py-2 rounded font-bold text-xs shadow flex justify-between items-center px-3 bg-yellow-500 text-white hover:bg-yellow-600 btn-opportunity">
                                <span><i class="fas fa-bolt"></i> Oportunidad Flash</span><span class="text-[9px] bg-yellow-700 px-1 rounded">Diario</span>
                            </button>
                            <div id="hustleStatus" class="hidden text-[10px] text-gray-400 text-center mt-1 italic">Oportunidad agotada por hoy.</div>
                        </div>
                    </div>

                    <div class="bg-blue-900 p-5 rounded shadow text-white relative-tip">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold">Cierre de Libros</h3>
                            <i class="fas fa-question-circle help-icon text-white" data-tip="Guarda progreso, cobra intereses y avanza al d√≠a siguiente."></i>
                        </div>
                        <button onclick="endDay()" class="w-full py-3 bg-red-700 hover:bg-red-600 rounded font-bold shadow text-sm border border-red-500 mt-2">EJECUTAR CIERRE DIARIO</button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded shadow overflow-hidden flex flex-col h-[600px]">
                    <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-blue-900 text-sm flex items-center gap-2"><i class="fas fa-balance-scale"></i> Mercado (MXN)</h3>
                    </div>
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3">Activo</th>
                                    <th class="px-3 py-3 text-center">Info</th>
                                    <th class="px-3 py-3 text-center">Tendencia</th>
                                    <th class="px-3 py-3 text-right">Precio</th>
                                    <th class="px-3 py-3 text-center">Posici√≥n</th>
                                    <th class="px-3 py-3 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="marketTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- RESULTADOS FINALES -->
        <section id="resultsSection" class="w-full max-w-4xl hidden fade-in mt-8">
            <div class="bg-white rounded-lg shadow-2xl overflow-hidden border-t-8 border-yellow-500">
                <div class="p-8 text-center bg-gray-900 text-white">
                    <h2 class="text-3xl font-bold mb-2 text-yellow-500">INFORME FINAL</h2>
                    <p class="text-sm text-gray-400">Auditor√≠a de Desempe√±o</p>
                </div>
                <div class="p-8 text-center">
                    <div id="badgeIcon" class="text-6xl mb-4 text-gray-300"></div>
                    <h3 id="rankTitle" class="text-xl font-bold text-blue-900 mb-1">...</h3>
                    <p class="text-xs text-gray-500 mb-6" id="rankDesc">...</p>
                    <div class="grid grid-cols-2 gap-8 text-sm border-t pt-6">
                        <div><p class="text-xs text-gray-500 uppercase">Capital Final</p><p class="text-4xl font-mono font-bold text-gray-800" id="finalNetWorth">$0.00</p></div>
                        <div><p class="text-xs text-gray-500 uppercase">Retorno (ROI)</p><p class="text-xl font-bold" id="finalROI">0%</p></div>
                    </div>
                    <button onclick="location.reload()" class="mt-8 bg-blue-900 text-white px-6 py-2 rounded text-sm font-bold hover:bg-blue-800">Cerrar Sistema</button>
                </div>
            </div>
        </section>

        <!-- MODALES -->
        <div id="infoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-2xl border-t-4 border-blue-900">
                <div class="flex justify-between items-start mb-4"><h3 class="text-xl font-bold text-blue-900" id="infoTitle"></h3><span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold uppercase" id="infoType"></span></div>
                <div class="mb-4 text-sm text-gray-700 leading-relaxed border-b border-gray-100 pb-4" id="infoDesc"></div>
                <div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-gray-50 p-2 rounded text-center"><p class="text-[10px] font-bold text-gray-500">Riesgo</p><p class="text-sm font-bold text-red-700" id="infoRisk"></p></div><div class="bg-gray-50 p-2 rounded text-center"><p class="text-[10px] font-bold text-gray-500">Volatilidad</p><p class="text-sm font-bold text-orange-600" id="infoVol"></p></div></div>
                <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400 mb-4"><p class="text-[10px] text-yellow-800 uppercase font-bold">Consejo:</p><p class="text-xs text-gray-600 italic mt-1" id="infoTip"></p></div>
                <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="w-full py-2 text-xs font-bold bg-blue-900 text-white rounded">Cerrar</button>
            </div>
        </div>

        <div id="expertModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl">
                <h3 class="text-lg font-bold text-blue-900 mb-4">Selecciona un Analista</h3>
                <div class="space-y-2">
                    <button onclick="buyAdvice('junior')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">El Pasante</span><br><span class="text-[10px] text-gray-500">Barato, poco fiable.</span></div><span class="font-bold text-green-700">$500</span></button>
                    <button onclick="buyAdvice('senior')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">Analista Senior</span><br><span class="text-[10px] text-gray-500">An√°lisis s√≥lido.</span></div><span class="font-bold text-blue-700">$3,000</span></button>
                    <button onclick="buyAdvice('insider')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">El "Insider"</span><br><span class="text-[10px] text-gray-500">Informaci√≥n privilegiada.</span></div><span class="font-bold text-purple-700">$10,000</span></button>
                </div>
                <button onclick="document.getElementById('expertModal').classList.add('hidden')" class="mt-4 w-full py-2 text-xs text-gray-500">Cancelar</button>
            </div>
        </div>

        <div id="loanModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl"><h3 class="text-xl font-bold text-blue-900 mb-4"><i class="fas fa-university"></i> Cr√©dito</h3><p class="text-xs text-gray-500 mb-4">Tasa fija diaria.</p><div class="space-y-3"><div onclick="selectLoan('azteca')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-green-700">Banco Azteca</p><p class="text-xs text-gray-500">300k | Tasa 4%</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div><div onclick="selectLoan('santander')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-red-700">Santander</p><p class="text-xs text-gray-500">500k | Tasa 2.5%</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div><div onclick="selectLoan('bbva')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-blue-700">BBVA</p><p class="text-xs text-gray-500">1M | Tasa 1.2%</p><p class="text-[9px] text-red-500">* Req: $1.2M Patrimonio</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div></div><button onclick="document.getElementById('loanModal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-500 text-xs font-bold border rounded hover:bg-gray-100">Cancelar</button></div></div>

        <div id="hustleModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur"><div class="bg-yellow-50 rounded-lg w-full max-w-sm p-6 shadow-2xl border-2 border-yellow-400 text-center"><h3 class="text-xl font-black text-yellow-800 mb-2">OPORTUNIDAD</h3><p class="text-sm font-bold text-gray-800 mb-1" id="hustleTitle"></p><p class="text-xs text-gray-600 mb-4" id="hustleDesc"></p><div class="bg-white p-3 rounded border border-yellow-200 mb-4"><p class="text-xs font-bold text-gray-500 uppercase">Inversi√≥n</p><p class="text-xl font-mono font-bold text-gray-800" id="hustleCost"></p></div><div class="grid grid-cols-2 gap-3"><button onclick="document.getElementById('hustleModal').classList.add('hidden')" class="py-2 bg-gray-200 rounded text-xs font-bold text-gray-600">Ignorar</button><button onclick="executeHustle()" class="py-2 bg-yellow-500 text-white rounded text-xs font-bold hover:bg-yellow-600 shadow-lg">¬°Arriesgar!</button></div></div></div>

        <!-- TRADE MODAL FIXED -->
        <div id="tradeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur">
            <div class="bg-white p-6 rounded-lg w-80 shadow-2xl border-t-4 border-blue-900 relative">
                <h3 id="tradeAssetName" class="text-lg font-bold mb-1 text-blue-900">Orden</h3>
                <p class="text-xs text-gray-500 mb-2">Precio: <span id="tradeAssetPrice" class="text-black font-mono font-bold"></span></p>
                <div class="bg-blue-50 p-3 rounded mb-4 text-xs text-blue-900 border border-blue-100">
                    <div class="flex justify-between mb-1"><span>Tienes:</span> <b id="tradeOwnedQty" class="font-mono">0.00</b></div>
                    <div class="flex justify-between"><span>Valor:</span> <b id="tradeOwnedVal" class="font-mono">$0.00</b></div>
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="setTradeMode('buy')" id="btnModeBuy" class="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white">COMPRAR</button>
                    <button onclick="setTradeMode('sell')" id="btnModeSell" class="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500">VENDER</button>
                </div>
                <div class="mb-4"><label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Monto (MXN)</label><input type="number" id="tradeAmount" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-gray-900 font-mono focus:border-blue-900 outline-none" placeholder="0.00"></div>
                <div class="flex gap-2"><button onclick="closeTradeModal()" class="flex-1 py-2 rounded border border-gray-300 text-gray-500 text-xs font-bold hover:bg-gray-100">CANCELAR</button><button onclick="executeTrade()" class="flex-1 py-2 rounded bg-blue-900 text-white font-bold text-xs hover:bg-blue-800 shadow">EJECUTAR</button></div>
            </div>
        </div>

        <!-- OREGON TRAIL END DAY -->
        <div id="saveModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[70] p-4">
            <div class="w-full max-w-lg text-center border-4 border-green-500 p-6 bg-black oregon-modal">
                <div id="pixelArtHeader" class="text-4xl mb-4"></div>
                <h2 class="text-xl font-bold mb-4 uppercase tracking-widest text-green-500" id="endDayTitle">D√çA TERMINADO</h2>
                <p class="text-xs mb-4 leading-relaxed" id="endDayMsg"></p>
                <div class="border border-green-900 p-2 mb-4 text-xs text-left" id="daySummary"></div>
                <p class="text-[10px] mb-2 uppercase blink text-red-500">¬°COPIA TU C√ìDIGO!</p>
                <div class="bg-green-900/20 p-3 rounded mb-4 border border-green-700 text-left overflow-hidden break-all"><code id="generatedCode" class="text-[10px] select-all cursor-text text-white font-mono">...</code></div>
                <button onclick="copyCode()" class="oregon-btn w-full mb-2">COPIAR AL PORTAPAPELES</button>
                <button onclick="location.reload()" class="oregon-btn w-full text-red-500 border-red-500 hover:bg-red-900 hover:text-white">SALIR DEL SISTEMA</button>
            </div>
        </div>
        
        <!-- TEACHER -->
        <div id="teacherLoginModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80]"><div class="bg-white p-6 rounded-lg max-w-sm w-full border-t-4 border-yellow-500"><h3 class="text-blue-900 font-bold text-lg mb-4">Acceso Docente</h3><input type="password" id="teacherPwd" class="w-full border border-gray-300 p-2 rounded mb-4 text-black bg-gray-50" placeholder="Contrase√±a"><div class="flex justify-end gap-2"><button onclick="document.getElementById('teacherLoginModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button><button onclick="checkTeacherLogin()" class="px-4 py-2 bg-blue-900 text-white rounded text-sm font-bold hover:bg-blue-800">Entrar</button></div></div></div>
        <section id="teacherSection" class="w-full max-w-4xl card p-6 hidden mt-8 mb-12 border-yellow-500"><div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4"><h2 class="text-xl font-bold text-blue-900">Auditor√≠a Docente</h2><button onclick="location.reload()" class="text-xs bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Cerrar Sesi√≥n</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><p class="text-xs text-gray-500 mb-2 font-bold uppercase">Token del Alumno:</p><textarea id="teacherInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 text-blue-900 retro-font text-xs h-32 focus:border-blue-900 outline-none mb-2"></textarea><button onclick="verifyStudentCode()" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 text-sm shadow">Auditar</button></div><div id="teacherResult" class="bg-gray-50 p-4 rounded border border-gray-200 text-sm h-full overflow-y-auto hidden"></div></div></section>
    </main>

    <footer class="bg-gray-900 text-gray-500 py-4 text-center text-[10px] mt-auto">
        <p>¬© 2025 Dr. Julio C. G. Quintero. Todos los derechos reservados.</p>
        <p class="mt-1 opacity-50">Plataforma educativa UDAL TRADER.</p>
    </footer>

<script>
const STUDENT_DB={"100017415":"AVELINO MATEO XIMENA DANIELA","100017697":"BAEZ ROSALES ANGEL HERSAI","100017904":"CARRILLO CASTELAN FERNANDA HARET","100017657":"CATAL LUCAS SANDRA","100018025":"CRUZ LUCAS AIDE NATIVIDAD","100017729":"CUAYA FUENTES ALEX","100018128":"FERRER RODRIGUEZ XIMENA","100017907":"GAONA SORIA ISAAC MARIANO","100017651":"GARCIA ALVAREZ SANTIAGO","100017652":"GIL MARTINEZ BERENICE","100017370":"HERNANDEZ CORTES FATIMA","100018166":"HILARIO CASTA√ëEDA ULISES","100017271":"MENA LORENZO OSCAR URIEL","100017869":"MERINO HERNANDEZ MARICRUZ","100018056":"MOCTEZUMA ORTEGA ARIEL","100017497":"MOLINA ENRIQUEZ RENE","100017665":"MORALES BELLO VANESSA","100017775":"MORALES GUTIEREZ ISAAC","100018096":"MORALES POBLANO EMILIO","100018164":"MU√ëOZ CASTA√ëEDA VALERIA","100017878":"NAVA FLORES SAUL EDUARDO","100017312":"NAVA MONTIEL CAMILA","100018099":"RAMIREZ CARREON EVA SOFIA","100018064":"RODRIGUEZ JIMENEZ MARIA ESTEFANIA","100017243":"SANCHEZ GONZALEZ CAMILA AMEYALTZIN","100017751":"VARGAS CASTILLO INES","100018135":"VARGAS TIRSO MARICARMEN","100016403":"AGUILA CADENA ADALIF ANGELLIQUE","100016666":"AGUILAR MIXCOATL ANDRES GABRIEL","100015977":"ANGEL FLORES MARIA TERESA","100016587":"ARIZA AGUILAR DANNA","100016046":"ARROYO GIL MELISSA","100016190":"AVALOS OLIVAS OLGA MABEL","100016786":"CONTRERAS APANGO VALERIA","100016972":"CORTES DOMINGUEZ SAYURI ALONDRA","100016254":"CORTEZ CALDERON KRIZIA NICOLE","100016271":"DEGANTE SILVERIO AXEL","100016352":"FERNANDEZ ITURRIAGA NICOLAS","100016393":"FLORES MANZANO MARYFER","100016664":"FLORES SALAZAR LUIS RICARDO","100016663":"JARQUIN FLORES ESMERALDA","100016570":"LUNA MARCOS JOSE MARIA","100016493":"MOO VASQUEZ CARLOS ARIEL","100016969":"PERALTA GONZALEZ ALEXANDRA","100016181":"ROMERO NU√ëEZ DIEGO GAEL","100015510":"AGUILAR ARELLANO YARIMETH","100015705":"AGUILAR HIDALGO EDGAR MANUEL","100014782":"AGUILAR PEREZ DULCE ARANZA","100015254":"COYOTL SOTO JESUS EDUARDO","100015436":"GONZALEZ TOXTLE ADILENE","100015146":"LEAL GOMEZ KAREN JANINA","100015789":"LOPEZ ANDRADE IRVIN DANIEL","100015504":"MARTINEZ ROMERO GUADALUPE","100015161":"MORALES ROJAS XIMENA","100014091":"MU√ëOZ CASTA√ëEDA JOSE MANUEL","100015332":"OREA ZARATE MARIANA","100015612":"OSORIO GARCIA JESSICA EMILY","100015244":"PEREZ VAZQUEZ RICARDO","100015601":"SANCHEZ LEON ANIEFH MICHELLE","100015166":"TEHUITZIL RODRIGUEZ YAEL","100015112":"TELLEZ FLORES FRANCISCO JAVIER","100015093":"TORNEZ ROQUE MILKA GUADALUPE","100014418":"AGUILAR MORALES JUARYTH","100014714":"ANDRADE REYES ALEJANDRO","100015048":"ANDRADE VELAZQUEZ MELISA","100014785":"BRAVO RAMIREZ SUANY YARLETH","100014786":"CAMACHO HERNANDEZ JOSE LUIS","100014094":"CASTA√ëEDA CRUZ ALBERTO","100014439":"COYOTL HUANETL DAVID","100014290":"FLORES FIGUEROA YARET CELIA","100014235":"LOPEZ GARCIA PEDRO ANDRES","100014275":"MARTINEZ MARTINEZ REGINA","100014715":"POTENCIANO ROMERO URIEL DE JESUS","100014115":"VELAZQUEZ MOYOTL ANA JOLETTE","100013212":"ALTAMIRA GUEVARA ALEX ALBERTO","100013240":"CUAZITL VELASCO MIRIAM ALONDRA","100015586":"ALVARO GONZALEZ REY DAVID","100015408":"CORTES CASTRO PATRICIA","100015247":"GARCIA MENESES KENIA","100015389":"GONZALEZ BAUTISTA MARIANNE","100015301":"JERONIMO GONZALEZ ALY ESTEPHANY","100015303":"LOPEZ MARTINEZ LORELEI JANETH","100015212":"MAGA√ëA DE JESUS JAZMIN ARLETTE","100015383":"MARTINEZ HERNANDEZ ANA MONTSERRAT","100015809":"PAEZ DE LEON IAN CARLOS","100015419":"PEREZ HUACHINA YURIDIA","100015515":"PORRAS PROMOTOR ANA PAOLA","100015243":"SALAMA AGUILAR EMILIO","100015442":"VAZQUEZ RAMIREZ MILDRE AZUCENA","100014672":"AGUILAR JUAREZ DANIEL","100014724":"ARCE FLORES ALDO","100014053":"BORJA SANCHEZ RICARDO SAID","100014127":"CAMACHO MACIN ARACELI","100014114":"DE MERCED HUERTA ALONDRA","100014274":"GARCIA ALVAREZ ERENDIRA SAMANTA","100014277":"GARCIA LOPEZ DANNA PAOLA","100014658":"HERNANDEZ RODRIGUEZ NADIA","100014109":"NIEMBRO ROJAS COVADONGA","100014456":"NI√ëO MARTINEZ JOSE MANUEL","100014554":"RAMIREZ PALACIOS JAFET","100017960":"BAEZ MOXO GERARDO ALEXIS","100018143":"BALTAZAR TAPIA CAMILA","100017495":"CABA√ëAS SANCHEZ CARLOS","100017538":"DIRCIO VENEGAS CRISTIAN EMMANUEL","100017890":"ESPINOSA HERNANDEZ KARLA DANIELA","100017896":"ESQUIVEL LOPEZ MARIA LIZBETH","100017738":"FLORES BARBOSA MIA ANDREA","100018159":"FLORES ZEFERINO GUADALUPE","100017492":"FUENTECILLA SANTIAGO MINERVA","100017424":"JIMENEZ HERNANDEZ JUAN MANUEL","100017568":"JIMENEZ MELENDEZ JULISSA","100017733":"JIMENEZ MELQUIADES ALARICK ISAI","100018163":"JUAREZ REYES MOISES","100017418":"LOYOLA ORTEGA NURI GUADALUPE","100018146":"MARTINEZ LUNA EDITH","100018173":"MONROY ZAMORA JOSUE GERMAN","100017529":"MORENO BRISE√ëO CINTHIA","100018001":"OLIVAREZ GARCIA AXCEL","100017756":"RAMIREZ DAMAS VALERY HAIDE","100017660":"REYES CELAYA ISAMAR","100017668":"ROJAS GARCIA AQUETZALIN","100018183":"RUIZ LIMA ESTEFANIA","100018160":"SANTAMARIA SORIANO DULCE MARIELA","100017952":"SANTOS GUTIERREZ DULCE VALERIA","100018051":"SEGURA LEON VALERIA MICHEL","100018065":"TENIZA MOSON ARANZA BELEM","100018092":"V√ÅZQUEZ MONTIEL VALERIA","100016789":"AMADOR BELLO BRANDON","100016387":"BECERRA LOEZA MARIAN ANGELA","100016593":"BLANCO CASTELLANOS KARLA LUPITA","100016950":"BRUNO ORTIZ DIANA LAURA","100016150":"CABRERA CRUZ PILAR","100016402":"CHARRO QUINTANA MAYREL","100016992":"CORDERO MONTIEL GALIA","100016349":"CRESPO DE LA CRUZ LEHOMAR","100016650":"GARCIA GARCIA DIEGO ENRIQUE","100016958":"HERNANDEZ HERRERA AUSTIN ALEJANDRO","100016398":"HERNANDEZ LUIS EMMA PAOLA","100016673":"LOPEZ PEREZ MIGUEL ANGEL","100016136":"LUNA ORTEGA SANDY","100016917":"ORIZAVA RIVERA OLIVER","100016500":"PEREZ VAZQUEZ FABIAN","100016784":"RAMOS MENDEZ LIZBETH","100016702":"ROJAS FLORES ABIGAIL","100016872":"ROJAS SANCHEZ JOSE MANUEL","100016782":"SANCHEZ CASTILLO DAFNE SARAI","100016923":"SANCHEZ SAN MARTIN JUAN YARED","100016754":"SANTOS ROJAS JOSELIN","100016874":"SAUCEDO DELGADO ASHLEY"};

/* --- UTILS --- */
function fmtMoney(n) { return "$" + n.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}); }
// UTF-8 SAFE BASE64 FUNCTIONS (CRITICAL FIX FOR TOKENS)
function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

/* --- CONFIG --- */
const MAX_DAYS = 7;
const INITIAL_CASH = 1000000;
const assetsDB = [
    { id: 'ipc', name: 'IPC M√©xico', type: '√çndice', base: 54000, desc: "√çndice de Precios y Cotizaciones. Refleja la econom√≠a mexicana.", risk: "Medio", vol: "Media", hist: [1, 1.01, 1.005, 0.98, 0.95, 0.96, 0.99] },
    { id: 'spx', name: 'S&P 500', type: '√çndice', base: 9500, desc: "Las 500 empresas m√°s grandes de EE.UU.", risk: "Medio", vol: "Baja", hist: [1, 1.02, 1.03, 1.01, 0.90, 0.92, 0.95] },
    { id: 'usd', name: 'D√≥lar (USD)', type: 'Divisa', base: 19.80, desc: "Moneda de reserva mundial. Activo de refugio.", risk: "Bajo", vol: "Baja", hist: [1, 1.01, 1.03, 1.05, 1.10, 1.08, 1.07] },
    { id: 'nvda', name: 'NVIDIA', type: 'Acci√≥n', base: 2800, desc: "L√≠der mundial en chips de IA. Alta volatilidad.", risk: "Alto", vol: "Muy Alta", hist: [1, 1.05, 1.12, 1.15, 0.70, 0.80, 0.95] },
    { id: 'amzn', name: 'Amazon', type: 'Acci√≥n', base: 3200, desc: "Gigante del e-commerce y servicios en la nube.", risk: "Medio", vol: "Media", hist: [1, 0.98, 0.99, 1.02, 1.04, 1.06, 1.10] },
    { id: 'googl', name: 'Google', type: 'Acci√≥n', base: 3400, desc: "Dominio en b√∫squedas y publicidad digital.", risk: "Medio", vol: "Media", hist: [1, 1.01, 1.01, 1.02, 0.99, 1.01, 1.03] },
    { id: 'tsla', name: 'Tesla', type: 'Acci√≥n', base: 4100, desc: "Veh√≠culos el√©ctricos. Muy sensible a noticias.", risk: "Muy Alto", vol: "Extrema", hist: [1, 1.05, 1.02, 0.95, 0.90, 0.85, 1.15] },
    { id: 'gold', name: 'Oro', type: 'Commodity', base: 35000, desc: "Refugio cl√°sico contra la inflaci√≥n.", risk: "Bajo", vol: "Baja", hist: [1, 1.01, 1.02, 1.04, 1.05, 1.06, 1.07] },
    { id: 'oil', name: 'Petr√≥leo WTI', type: 'Commodity', base: 1400, desc: "Energ√≠a global. Sensible a geopol√≠tica.", risk: "Alto", vol: "Alta", hist: [1, 1.05, 1.10, 1.15, 1.00, 0.90, 0.85] },
    { id: 'pemex', name: 'Bonos PEMEX', type: 'Obligaci√≥n', base: 100, desc: "Deuda de petrolera estatal. Riesgo pa√≠s.", risk: "Alto", vol: "Media", hist: [1, 0.99, 0.98, 0.95, 0.90, 0.85, 0.88] },
    { id: 'bimbo', name: 'Cert. BIMBO', type: 'Obligaci√≥n', base: 105, desc: "Deuda corporativa estable de consumo masivo.", risk: "Bajo", vol: "Baja", hist: [1, 1.001, 1.002, 1.003, 1.004, 1.005, 1.006] },
    { id: 'cetes', name: 'CETES 28', type: 'Bono Gov', base: 10, desc: "Certificados de la Tesorer√≠a. La opci√≥n m√°s segura.", risk: "Nulo", vol: "Nula", hist: [1, 1.002, 1.004, 1.006, 1.008, 1.010, 1.012] },
    { id: 'btc', name: 'Bitcoin', type: 'Cripto', base: 1300000, desc: "Oro digital. Potencial masivo y riesgo de p√©rdida total.", risk: "Extremo", vol: "Extrema", hist: [1, 1.10, 1.20, 0.90, 0.85, 1.25, 1.40] }
];
const startScenarios = [{ fin: ["Bolsa Mexicana toca m√°ximos.", "NVIDIA lidera el rally."], eco: ["Confianza consumidor alta.", "Tech imparables."], hint: "El mercado est√° euf√≥rico." }, { fin: ["Temores de recesi√≥n.", "Petr√≥leo cae."], eco: ["PIB desacelera.", "Alerta construcci√≥n."], hint: "Tiempos inciertos. Busca seguridad." }, { fin: ["Bitcoin rompe barreras.", "Fiebre IA."], eco: ["¬øBurbuja?", "Alta volatilidad."], hint: "Alto riesgo, alta recompensa." }];
const fixedNews = [null, null, { fin: ["Regulaci√≥n Tech Europa.", "La deuda de PEMEX preocupa."], eco: ["Multa a NVIDIA.", "Incertidumbre cambiaria."], hint: "Cuidado con NVIDIA y PEMEX." }, { fin: ["Inflaci√≥n repunta ligeramente.", "Tasas se mantienen altas."], eco: ["Banxico firme.", "BIMBO s√≥lida."], hint: "Deuda corporativa s√≥lida es refugio." }, { fin: ["¬°ALERTA ROJA! NVIDIA fraude.", "S&P 500 cae con fuerza."], eco: ["P√°nico vendedor.", "Inversores liquidan."], hint: "¬°VENDE RIESGO! Busca liquidez." }, { fin: ["Mercados intentan estabilizarse.", "D√≥lar se dispara."], eco: ["Cazadores de ofertas.", "NVIDIA m√≠nimos."], hint: "¬øRebote t√©cnico? Compra barato." }, { fin: ["Gobierno rescata deuda.", "Amazon sorprende."], eco: ["Hacienda recompra.", "Consumo fuerte."], hint: "Consumo y Cripto recuperan." }, { fin: ["Cierre de ejercicio.", "Resultados mixtos."], eco: ["Fin ciclo.", "Balances finales."], hint: "Asegura ganancias. Cierra libros." }];
const hustles = [{ title: "Lote de Vapes", desc: "Mercanc√≠a china 'gris'.", cost: 50000, riskText: "Polic√≠a confisc√≥ todo." }, { title: "Puesto de Tacos", desc: "Traspaso de local.", cost: 100000, riskText: "Clausurado por salubridad." }, { title: "Pr√©stamo", desc: "Compa√±ero necesita dinero.", cost: 20000, riskText: "Compa√±ero desapareci√≥." }, { title: "NFTs Monos", desc: "Arte digital.", cost: 10000, riskText: "Era una estafa." }];

let gameState = { id: "", name: "", day: 1, cash: INITIAL_CASH, portfolio: {}, bypassed: 0, blackSwans: {}, narrativeId: 0, expertConsulted: false, loan: { bank: null, amount: 0, rate: 0 }, hustleDone: false };
assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
let currentNewsSource = 'fin';

/* --- UI --- */
function toggleLoginMode(mode) {
    const btnNew = document.getElementById('tabNew'), btnLoad = document.getElementById('tabLoad'), formNew = document.getElementById('newGameForm'), formLoad = document.getElementById('loadGameForm');
    if(mode === 'new') { formNew.classList.remove('hidden'); formLoad.classList.add('hidden'); btnNew.classList.replace('text-gray-400', 'text-blue-900'); btnNew.classList.add('border-blue-900'); btnLoad.classList.replace('text-blue-900', 'text-gray-400'); btnLoad.classList.remove('border-blue-900'); }
    else { formNew.classList.add('hidden'); formLoad.classList.remove('hidden'); btnLoad.classList.replace('text-gray-400', 'text-blue-900'); btnLoad.classList.add('border-blue-900'); btnNew.classList.replace('text-blue-900', 'text-gray-400'); btnNew.classList.remove('border-blue-900'); }
}

function startSequence() {
    const id = document.getElementById('studentId').value.trim();
    if(!id) return alert("Ingresa matr√≠cula");
    if(!STUDENT_DB[id]) return alert("‚õî Matr√≠cula no autorizada");
    gameState.id = id; gameState.name = STUDENT_DB[id]; gameState.day = 1; gameState.cash = INITIAL_CASH; gameState.portfolio = {};
    assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
    gameState.narrativeId = Math.floor(Math.random()*3); gameState.lastSaveTime = Date.now();
    gameState.expertConsulted = false; gameState.hustleDone = false; gameState.loan = {bank:null, amount:0, rate:0};
    document.getElementById('loginSection').classList.add('hidden'); document.getElementById('gameSection').classList.remove('hidden');
    renderGame();
}

/* --- CORE --- */
function renderGame() {
    document.getElementById('operatorNameDisplay').innerText = gameState.name;
    document.getElementById('operatorIdDisplay').innerText = gameState.id;
    document.getElementById('displayDay').innerText = `D√≠a ${gameState.day} / ${MAX_DAYS}`;
    document.getElementById('displayCash').innerText = fmtMoney(gameState.cash);
    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, gameState.day));
    const netWorth = gameState.cash + portVal - gameState.loan.amount;
    document.getElementById('displayPortfolioVal').innerText = fmtMoney(portVal);
    document.getElementById('displayNetWorth').innerText = fmtMoney(netWorth);
    
    // Expert Button Logic
    const btnExp = document.getElementById('btnExpert');
    const expertCost = netWorth < INITIAL_CASH ? 1000 : 5000;
    if(gameState.expertConsulted) {
        btnExp.classList.remove('bg-gray-100', 'text-gray-700');
        btnExp.classList.add('bg-green-100', 'text-green-800');
        btnExp.innerHTML = `<span><i class="fas fa-check-circle"></i> Ver Consejo</span>`;
    } else {
        btnExp.classList.add('bg-gray-100', 'text-gray-700');
        btnExp.classList.remove('bg-green-100', 'text-green-800');
        btnExp.innerHTML = `<span><i class="fas fa-user-tie"></i> Consultar Analista</span><span class="text-[9px] bg-gray-300 px-1 rounded" id="expertCostBadge">${fmtMoney(expertCost)}</span>`;
    }
    
    // Loan Button
    if(gameState.loan.amount > 0) { document.getElementById('btnLoan').classList.add('hidden'); document.getElementById('loanStatus').classList.remove('hidden'); }
    else { document.getElementById('btnLoan').classList.remove('hidden'); document.getElementById('loanStatus').classList.add('hidden'); }

    // Hustle Button Logic
    const btnHustle = document.getElementById('btnHustle');
    if(gameState.hustleDone) {
        btnHustle.classList.add('opacity-50', 'cursor-not-allowed');
        document.getElementById('hustleStatus').classList.remove('hidden');
    } else {
        btnHustle.classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('hustleStatus').classList.add('hidden');
    }

    renderNews(); renderTable();
}

function renderTable() {
    const tbody = document.getElementById('marketTableBody'); tbody.innerHTML = '';
    assetsDB.forEach(a => {
        const price = getPrice(a, gameState.day); const qty = gameState.portfolio[a.id] || 0;
        let status = '‚ñ¨'; const swanMult = (gameState.blackSwans && gameState.blackSwans[a.id]) !== undefined ? gameState.blackSwans[a.id] : null;
        if(swanMult !== null) { if(swanMult > 1.2) status='üöÄ'; else if(swanMult < 0.1) status='üíÄ'; else status='üîª'; }
        else if(gameState.day > 1) { const prev = getPrice(a, gameState.day - 1); const change = (price - prev)/prev; if(change > 0.03) status='‚ñ≤‚ñ≤'; else if(change > 0) status='‚ñ≤'; else if(change < -0.03) status='‚ñº‚ñº'; else if(change < 0) status='‚ñº'; }
        
        const tr = document.createElement('tr'); tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-100";
        tr.innerHTML = `<td class="px-3 py-3 font-bold text-blue-900 text-xs">${a.name}</td><td class="px-3 py-3 text-center"><button onclick="showInfo('${a.id}')" class="text-[9px] bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 py-1 rounded">FICHA</button></td><td class="px-3 py-3 text-center text-xs font-bold text-gray-500">${status}</td><td class="px-3 py-3 text-right font-mono text-xs text-gray-700 font-bold">${fmtMoney(price)}</td><td class="px-3 py-3 text-center text-xs text-gray-500">${qty.toFixed(2)}</td><td class="px-3 py-3 text-center"><button onclick="openTrade('${a.id}')" class="bg-blue-900 hover:bg-blue-800 text-white text-[10px] px-3 py-1 rounded font-bold shadow">OPERAR</button></td>`;
        tbody.appendChild(tr);
    });
}

function getPrice(asset, day) {
    if(day === 0) return asset.base;
    let multiplier = 1; if(gameState.blackSwans && gameState.blackSwans[asset.id] !== undefined) multiplier = gameState.blackSwans[asset.id];
    let idx = day - 1; if(idx >= asset.hist.length) idx = asset.hist.length - 1;
    return asset.base * asset.hist[idx] * multiplier;
}

function renderNews() {
    let data; if(gameState.day === 1) data = startScenarios[gameState.narrativeId || 0]; else data = fixedNews[gameState.day] || { fin:[], eco:[], hint:"" };
    const items = currentNewsSource === 'fin' ? data.fin : data.eco; const title = currentNewsSource === 'fin' ? 'EL FINANCIERO' : 'EL ECONOMISTA'; const color = currentNewsSource === 'fin' ? 'text-orange-700' : 'text-blue-900';
    document.getElementById('newsTitle').innerText = title; document.getElementById('newsTitle').className = `headline-font font-black text-2xl leading-none ${color}`;
    const feed = document.getElementById('newsFeed'); feed.innerHTML = '';
    items.forEach(txt => { const borderCol = title.includes('FINANCIERO') ? 'border-orange-400' : 'border-blue-900'; feed.innerHTML += `<div class="border-l-4 ${borderCol} pl-3 py-1"><p class="font-serif font-bold text-gray-800 text-xs leading-tight">${txt}</p></div>`; });
}
function toggleNewsSource() { currentNewsSource = currentNewsSource === 'fin' ? 'eco' : 'fin'; renderNews(); }

/* --- MODALS --- */
function showInfo(id) {
    const a = assetsDB.find(x => x.id === id);
    document.getElementById('infoTitle').innerText = a.name; document.getElementById('infoDesc').innerText = a.desc; document.getElementById('infoType').innerText = a.type; document.getElementById('infoRisk').innerText = a.risk; document.getElementById('infoVol').innerText = a.vol; document.getElementById('infoTip').innerText = a.tip;
    document.getElementById('infoModal').classList.remove('hidden'); document.getElementById('infoModal').classList.add('flex');
}
function openExpertModal() {
    if(gameState.expertConsulted) {
        let hint = "Sin datos."; if(gameState.day < MAX_DAYS) { const d = fixedNews[gameState.day+1]; if(d) hint = d.hint; }
        return alert(`CONSEJO ACTIVO:\n"${hint}"`);
    }
    document.getElementById('expertModal').classList.remove('hidden'); document.getElementById('expertModal').classList.add('flex');
}
function buyAdvice(type) {
    let cost = type === 'junior' ? 500 : (type === 'senior' ? 3000 : 10000);
    if(gameState.cash < cost) return alert("Sin fondos.");
    if(!confirm(`¬øPagar ${fmtMoney(cost)}?`)) return;
    gameState.cash -= cost; gameState.expertConsulted = true;
    document.getElementById('expertModal').classList.add('hidden');
    let hint = "Sin datos."; if(gameState.day < MAX_DAYS) { const d = fixedNews[gameState.day+1]; if(d) hint = d.hint; }
    let msg = hint; if(type === 'junior' && Math.random() > 0.5) msg = "El mercado est√°... raro.";
    alert(`CONSEJO:\n"${msg}"`); renderGame();
}
function openLoanModal() { document.getElementById('loanModal').classList.remove('hidden'); }
function selectLoan(bank) {
    let amt=0, rate=0; if(bank==='azteca'){amt=300000;rate=0.04;} else if(bank==='santander'){amt=500000;rate=0.025;} else if(bank==='bbva'){ let p=0; assetsDB.forEach(a=>p+=(gameState.portfolio[a.id]||0)*getPrice(a,gameState.day)); if((gameState.cash+p)<1200000 && Math.random()>0.3) return alert("Rechazado."); amt=1000000;rate=0.012;}
    if(confirm(`¬øAceptar cr√©dito?\nRecibes: ${fmtMoney(amt)}\nTasa: ${(rate*100)}%`)) { gameState.loan={bank,amount:amt,rate}; gameState.cash+=amt; document.getElementById('loanModal').classList.add('hidden'); renderGame(); }
}
function payLoan() {
    if(gameState.loan.amount <= 0) return;
    if(gameState.cash < gameState.loan.amount) return alert("Fondos insuficientes.");
    if(confirm(`¬øPagar deuda de ${fmtMoney(gameState.loan.amount)}?`)) { gameState.cash -= gameState.loan.amount; gameState.loan={bank:null,amount:0,rate:0}; renderGame(); }
}
function openHustleModal() { if(gameState.hustleDone) return; const h = hustles[Math.floor(Math.random()*hustles.length)]; gameState.tempHustle=h; document.getElementById('hustleTitle').innerText=h.title; document.getElementById('hustleDesc').innerText=h.desc; document.getElementById('hustleCost').innerText=fmtMoney(h.cost); document.getElementById('hustleModal').classList.remove('hidden'); }
function executeHustle() {
    const h = gameState.tempHustle; if(!h || gameState.cash < h.cost) return alert("Sin fondos.");
    gameState.cash -= h.cost; document.getElementById('hustleModal').classList.add('hidden'); gameState.hustleDone = true;
    if(Math.random() > 0.5) { const profit = h.cost*(1.5+Math.random()); gameState.cash+=profit; alert(`üéâ ¬°√âXITO! Ganaste ${fmtMoney(profit-h.cost)}`); } else { alert(`üìâ FRACASO. ${h.riskText}`); } renderGame();
}

/* --- TRADE --- */
let currTradeId = null, tradeMode = 'buy';
function openTrade(id) { 
    currTradeId=id; tradeMode='buy'; const a=assetsDB.find(x=>x.id===id); const p=getPrice(a,gameState.day); const own=gameState.portfolio[id]||0;
    document.getElementById('tradeModal').classList.remove('hidden'); document.getElementById('tradeModal').classList.add('flex');
    document.getElementById('tradeAssetName').innerText=a.name; document.getElementById('tradeAssetPrice').innerText=fmtMoney(p);
    document.getElementById('tradeOwnedQty').innerText=own.toFixed(4); document.getElementById('tradeOwnedVal').innerText=fmtMoney(own*p);
    document.getElementById('tradeAmount').value=''; setTradeMode('buy');
}
function setTradeMode(m) { tradeMode=m; const bB=document.getElementById('btnModeBuy'), bS=document.getElementById('btnModeSell'); if(m==='buy'){bB.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white";bS.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500";}else{bS.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white";bB.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500";} }
function closeTradeModal() { document.getElementById('tradeModal').classList.add('hidden'); document.getElementById('tradeModal').classList.remove('flex'); }
function executeTrade() {
    const amt = parseFloat(document.getElementById('tradeAmount').value); if(!amt || amt<=0) return;
    const a=assetsDB.find(x=>x.id===currTradeId); const p=getPrice(a,gameState.day);
    if(tradeMode==='buy') { if(amt>gameState.cash)return alert("Sin fondos."); gameState.cash-=amt; if(!gameState.portfolio[currTradeId])gameState.portfolio[currTradeId]=0; gameState.portfolio[currTradeId]+=amt/p; }
    else { const v=(gameState.portfolio[currTradeId]||0)*p; if(amt>v+1)return alert("Sin activos."); if(Math.abs(amt-v)<10){gameState.cash+=v;gameState.portfolio[currTradeId]=0;}else{gameState.cash+=amt;gameState.portfolio[currTradeId]-=amt/p;} }
    closeTradeModal(); renderGame();
}

/* --- END DAY --- */
function endDay() {
    if(!confirm("¬øCerrar d√≠a?")) return;
    let loanMsg = ""; if(gameState.loan.amount>0) { const int=gameState.loan.amount*gameState.loan.rate; gameState.cash-=int; loanMsg=`Inter√©s pagado: -${fmtMoney(int)}`; }
    
    // Check Random Events (20% chance)
    if(gameState.day > 2) {
        assetsDB.forEach(a => {
            if(Math.random() < 0.20 && gameState.blackSwans[a.id] === undefined) {
                 if (a.id === 'nvda') gameState.blackSwans[a.id] = 0.6; // Crash
                 else if (a.id === 'pemex') gameState.blackSwans[a.id] = 1.5; // Moon
                 else if (a.type === 'Cripto') gameState.blackSwans[a.id] = 0.00; // Rug
            }
        });
    }

    let portVal=0; assetsDB.forEach(a=>portVal+=(gameState.portfolio[a.id]||0)*getPrice(a,gameState.day));
    const net = gameState.cash + portVal - gameState.loan.amount; const roi = net - INITIAL_CASH;
    let art="üòê", col="text-gray-500", irony="";
    if(roi>100000){art="üöÄ";col="text-green-400";irony="El mercado te ama.";}
    else if(roi>0){art="üìà";col="text-green-600";irony="Sobreviviste.";}
    else if(roi<-100000){art="üíÄ";col="text-red-600";irony="Tu cuenta sangra.";}
    else{art="üìâ";col="text-yellow-600";irony="Vas perdiendo dignidad.";}
    
    document.getElementById('pixelArtHeader').innerHTML=art; document.getElementById('endDayTitle').className=`text-xl font-bold mb-2 pixel-font text-xs ${col}`;
    document.getElementById('endDayMsg').innerText = roi >= 0 ? `Ganancia: +${fmtMoney(roi)}` : `P√©rdida: ${fmtMoney(roi)}`;
    document.getElementById('endDayIrony').innerText = irony; document.getElementById('daySummary').innerText = loanMsg;

    if(gameState.day >= MAX_DAYS) { showResults(); return; }

    let next = JSON.parse(JSON.stringify(gameState)); next.day++; next.expertConsulted=false; next.hustleDone=false; delete next.name; next.lastSaveTime = Date.now();
    const code = "UDAL-" + utf8_to_b64(JSON.stringify(next)).split('').reverse().join('');
    document.getElementById('generatedCode').innerText = code; document.getElementById('saveModal').classList.remove('hidden'); document.getElementById('saveModal').classList.add('flex');
}

/* --- LOAD --- */
function showResults() {
    document.getElementById('gameSection').classList.add('hidden'); document.getElementById('resultsSection').classList.remove('hidden'); document.getElementById('resultsSection').classList.add('flex');
    let portVal=0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, MAX_DAYS));
    const net = gameState.cash + portVal - gameState.loan.amount; const roi = ((net - INITIAL_CASH)/INITIAL_CASH)*100;
    document.getElementById('finalNetWorth').innerText = fmtMoney(net); document.getElementById('finalROI').innerText = roi.toFixed(2)+"%";
    const icon = document.getElementById('badgeIcon'), title = document.getElementById('rankTitle'), desc = document.getElementById('rankDesc');
    if(net > 1200000) { icon.innerHTML = 'üëë'; title.innerText = "MAGNATE"; desc.innerText = "Imperio construido."; }
    else if (net > 1050000) { icon.innerHTML = 'üíº'; title.innerText = "EJECUTIVO"; desc.innerText = "Ganancias s√≥lidas."; }
    else if (net > 1000000) { icon.innerHTML = 'üòê'; title.innerText = "SOBREVIVIENTE"; desc.innerText = "Ni ganaste ni perdiste."; }
    else { icon.innerHTML = 'üíÄ'; title.innerText = "QUIEBRA"; desc.innerText = "Vendes cursos en TikTok."; }
}

function loadGame() {
    // Smart Cleaner
    let code = document.getElementById('saveCodeInput').value.trim().replace(/[\s\n\r]+/g, '');
    let bypass = false;
    
    if(code.indexOf("UDAL42-") !== -1) { bypass = true; code = code.replace("UDAL42-", "UDAL-"); }
    else if(code.indexOf("UDAL-") === -1) return alert("Formato inv√°lido (Debe empezar con UDAL-)");

    try {
        const json = b64_to_utf8(code.replace("UDAL-", "").split('').reverse().join(''));
        const data = JSON.parse(json);
        if(!data.loan) data.loan = {bank:null, amount:0, rate:0};
        
        if(data.id && STUDENT_DB[data.id]) data.name = STUDENT_DB[data.id]; else data.name = "Desconocido";

        if(!bypass && data.day > 1 && data.lastSaveTime) {
            const hours = (Date.now() - data.lastSaveTime) / 36e5;
            if(hours < 24) return alert(`Mercado cerrado. Espera ${Math.ceil(24-hours)}h.`);
        }
        
        gameState = data;
        renderGame(); // Force rendering updates before switching view
        if(gameState.day > MAX_DAYS) showResults(); 
        else {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }
    } catch(e) { console.error(e); alert("Token corrupto."); }
}

function copyCode() { navigator.clipboard.writeText(document.getElementById('generatedCode').innerText); alert("Copiado"); }
function checkTeacherLogin() { if(document.getElementById('teacherPwd').value === "udalintrader") { document.getElementById('teacherLoginModal').classList.add('hidden'); document.getElementById('teacherSection').classList.remove('hidden'); } }
function showTeacherLogin() { document.getElementById('teacherLoginModal').classList.remove('hidden'); document.getElementById('teacherLoginModal').classList.add('flex'); }
function verifyStudentCode() {
    let code = document.getElementById('teacherInput').value.trim().replace(/[\s\n\r]+/g, '');
    if(code.indexOf("UDAL42-") !== -1) code = code.replace("UDAL42-", "UDAL-");
    try {
        const json = b64_to_utf8(code.replace("UDAL-", "").split('').reverse().join(''));
        const data = JSON.parse(json);
        let name = (data.id && STUDENT_DB[data.id]) ? STUDENT_DB[data.id] : "Desconocido";
        let total = data.cash; assetsDB.forEach(a => { let idx = (data.day > 1) ? data.day - 2 : 0; total += (data.portfolio[a.id]||0) * (a.base * a.hist[idx]); });
        if(data.loan) total -= data.loan.amount;
        document.getElementById('teacherResult').classList.remove('hidden');
        document.getElementById('teacherResult').innerHTML = `<p class="font-bold text-blue-900">Alumno: ${name}</p><p class="text-xs text-gray-500">ID: ${data.id}</p><p>D√≠a Actual: ${data.day}</p><p class="text-xl font-bold text-green-700">${fmtMoney(total)}</p>`;
    } catch(e){ alert("Error al leer token"); }
}
</script>
</body>
</html>