<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDAL TRADER - Simulador de Mercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Montserrat:wght@400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,300&family=Playfair+Display:wght@700;900&family=Press+Start+2P&display=swap');
        
        /* COLORES INSTITUCIONALES UDAL */
        :root {
            --udal-blue: #002855; 
            --udal-red: #a51c30;  
            --paper-bg: #fdfbf7;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        .retro-font { font-family: 'Roboto Mono', monospace; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .serif-font { font-family: 'Merriweather', serif; }
        .headline-font { font-family: 'Playfair Display', serif; }
        
        .card { background-color: white; border-top: 4px solid var(--udal-blue); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .btn-udal { background-color: var(--udal-blue); color: white; transition: all 0.2s; }
        .btn-udal:hover { background-color: #0f172a; transform: translateY(-1px); }
        .btn-danger { background-color: var(--udal-red); color: white; }
        .btn-danger:hover { background-color: #7f1d1d; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Efecto Peri√≥dico */
        .newspaper {
            background-color: var(--paper-bg);
            border: 1px solid #d1d5db;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .newspaper::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--udal-blue) 0%, var(--udal-red) 100%);
        }

        /* Tooltips D√≠a 1 */
        .help-icon { cursor: help; color: var(--udal-blue); margin-left: 5px; opacity: 0.7; }
        .help-icon:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 10px;
            font-family: sans-serif;
            width: 200px;
            text-align: center;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .relative-tip { position: relative; display: inline-block; }

        /* Scroll Personalizado para Tabla */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animaci√≥n Oportunidad */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        .btn-opportunity { animation: pulse-gold 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-between relative">

    <!-- Header -->
    <header class="w-full bg-white shadow-md z-10 relative">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center bg-white border-2 border-blue-900 w-16 h-10 rounded shadow overflow-hidden">
                    <span class="text-blue-900 font-black text-lg tracking-tighter">UDAL</span>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-blue-900 tracking-tighter">SIMULADOR <span class="text-red-800">DE MERCADOS</span></h1>
                </div>
            </div>
            <button onclick="showTeacherLogin()" class="text-xs text-gray-400 hover:text-blue-900 transition-colors"><i class="fas fa-lock"></i> Acceso Docente</button>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center p-4 relative w-full max-w-7xl mx-auto">
        
        <!-- INTRO / LOGIN -->
        <section id="loginSection" class="w-full max-w-lg card p-8 mb-4 fade-in mt-8 relative">
            <div class="absolute -top-3 -right-3 bg-red-700 text-white text-[10px] font-bold px-2 py-1 rounded shadow transform rotate-6">v4.0 Wall St.</div>
            
            <h2 class="text-xl font-bold mb-2 text-center text-blue-900">Plataforma de Trading</h2>
            <p class="text-xs text-center text-gray-500 mb-6 px-4">Entorno financiero profesional. Universidad de Am√©rica Latina.</p>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="toggleLoginMode('new')" id="tabNew" class="flex-1 py-2 text-blue-900 border-b-2 border-blue-900 font-bold text-sm">Nuevo Portafolio</button>
                <button onclick="toggleLoginMode('load')" id="tabLoad" class="flex-1 py-2 text-gray-400 text-sm hover:text-gray-600">Continuar Operativa</button>
            </div>

            <!-- Nuevo Juego -->
            <div id="newGameForm">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Nombre del Operador</label>
                <input type="text" id="studentName" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-4 text-gray-800 focus:outline-none focus:border-blue-900" placeholder="Ej. Ana Garc√≠a">
                
                <div class="flex items-center mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <input type="checkbox" id="guideCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                    <label for="guideCheck" class="ml-2 text-sm text-blue-900 font-semibold cursor-pointer">Activar Asistente de Interfaz (D√≠a 1)</label>
                </div>

                <button onclick="startSequence()" class="w-full btn-udal font-bold py-3 rounded shadow-lg">ACCEDER AL MERCADO</button>
            </div>

            <!-- Cargar Juego -->
            <div id="loadGameForm" class="hidden">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Token de Acceso</label>
                <textarea id="saveCodeInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-2 text-blue-900 retro-font text-xs h-24 focus:outline-none focus:border-blue-900" placeholder="Ingresa tu clave cifrada..."></textarea>
                <button onclick="loadGame()" class="w-full btn-danger font-bold py-3 rounded shadow-lg">RESTAURAR SESI√ìN</button>
                <div id="loadMsg" class="mt-3 text-center text-xs font-bold text-red-600 hidden"></div>
            </div>
        </section>

        <!-- DASHBOARD JUEGO -->
        <section id="gameSection" class="w-full hidden fade-in">
            
            <!-- Botonera Superior Extra -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <button onclick="openLoanModal()" id="btnLoan" class="text-xs bg-gray-800 text-white px-3 py-2 rounded shadow hover:bg-gray-700 flex items-center gap-2"><i class="fas fa-landmark"></i> Solicitar Cr√©dito</button>
                    <div id="loanStatus" class="hidden text-xs bg-red-100 text-red-800 px-3 py-2 rounded border border-red-200 font-bold flex items-center gap-1"><i class="fas fa-hand-holding-usd"></i> Deuda Activa</div>
                </div>
                <!-- Bot√≥n de Oportunidad (Hidden by default) -->
                <button onclick="openHustleModal()" id="btnHustle" class="hidden text-xs bg-yellow-500 text-white px-4 py-2 rounded shadow-lg btn-opportunity font-bold"><i class="fas fa-bolt"></i> OPORTUNIDAD FLASH</button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="statsBar">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-900 relative-tip">
                    <div class="flex justify-between">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Jornada</p>
                        <i class="fas fa-question-circle help-icon hidden" id="tipDay" data-tip="Indica tu progreso en la simulaci√≥n de 7 d√≠as."></i>
                    </div>
                    <p class="text-2xl font-bold retro-font text-blue-900" id="displayDay">D√≠a 1 / 7</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-600 relative-tip">
                    <div class="flex justify-between">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Liquidez (MXN)</p>
                        <i class="fas fa-question-circle help-icon hidden" id="tipCash" data-tip="Dinero en efectivo disponible para comprar o pagar servicios."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-green-700" id="displayCash">$1,000,000</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-purple-600 relative-tip">
                    <div class="flex justify-between">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Valor Mercado</p>
                        <i class="fas fa-question-circle help-icon hidden" id="tipVal" data-tip="Cu√°nto valdr√≠an tus activos si los vendieras hoy."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-purple-700" id="displayPortfolioVal">$0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-gray-800 relative-tip">
                    <div class="flex justify-between">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Patrimonio Neto</p>
                        <i class="fas fa-question-circle help-icon hidden" id="tipNet" data-tip="Tu valor total real (Efectivo + Activos - Deudas). Este es tu puntaje."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-gray-800" id="displayNetWorth">$1,000,000</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Sidebar -->
                <div class="lg:col-span-1 flex flex-col gap-4">
                    
                    <!-- Peri√≥dico -->
                    <div id="newsSection" class="newspaper p-5 rounded relative">
                        <div class="border-b-2 border-black mb-3 pb-2 flex justify-between items-end">
                            <div>
                                <h3 class="headline-font font-black text-2xl text-black leading-none" id="newsTitle">EL FINANCIERO</h3>
                                <p class="text-[9px] text-gray-500 font-serif mt-1">INFORMACI√ìN EN TIEMPO REAL</p>
                            </div>
                            <button onclick="toggleNewsSource()" class="text-[10px] border border-gray-400 px-2 py-1 rounded text-gray-600 hover:bg-white transition-colors relative-tip">
                                Fuente <i class="fas fa-sync-alt"></i>
                                <i class="fas fa-question-circle help-icon hidden" id="tipNews" data-tip="Alterna entre diarios para ver diferentes perspectivas."></i>
                            </button>
                        </div>
                        <div id="newsFeed" class="space-y-4"></div>
                    </div>

                    <!-- Bot√≥n Experto -->
                    <div class="bg-gray-50 border border-gray-200 p-4 rounded text-center">
                        <button onclick="consultExpert()" id="btnExpert" class="w-full py-2 rounded font-bold text-xs shadow transition-colors flex justify-center items-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300">
                            <i class="fas fa-chart-pie"></i> CONSULTOR√çA (<span id="expertCost">$5,000</span>)
                        </button>
                        <p id="expertResult" class="mt-2 text-sm font-bold hidden bg-yellow-100 p-2 rounded text-yellow-800 border-l-4 border-yellow-500 text-left italic"></p>
                    </div>

                    <!-- Bot√≥n Finalizar -->
                    <div class="bg-blue-900 p-5 rounded shadow text-white relative-tip">
                        <h3 class="font-bold mb-1 flex justify-between">Cierre de Libros <i class="fas fa-question-circle help-icon text-white hidden" id="tipEnd" data-tip="Termina el d√≠a actual, cobra intereses y guarda tu progreso."></i></h3>
                        <p class="text-[10px] text-blue-200 mb-3">Consolida posiciones y avanza al siguiente periodo.</p>
                        <button onclick="endDay()" class="w-full py-3 bg-red-700 hover:bg-red-600 rounded font-bold shadow text-sm transition-colors border border-red-500">
                            EJECUTAR CIERRE DIARIO
                        </button>
                    </div>
                </div>

                <!-- Tabla de Mercado -->
                <div class="lg:col-span-2 bg-white rounded shadow overflow-hidden flex flex-col h-[500px]">
                    <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-blue-900 text-sm flex items-center gap-2">
                            <i class="fas fa-balance-scale"></i> Pizarra de Cotizaciones
                        </h3>
                        <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded">MXN</span>
                    </div>
                    
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 bg-gray-100">Instrumento</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Tendencia</th>
                                    <th class="px-3 py-3 text-right bg-gray-100">Precio</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Posici√≥n</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Orden</th>
                                </tr>
                            </thead>
                            <tbody id="marketTableBody" class="divide-y divide-gray-100">
                                <!-- Filas JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN RESULTADOS FINALES -->
        <section id="resultsSection" class="w-full max-w-4xl hidden fade-in mt-8">
            <div class="bg-white rounded-lg shadow-2xl overflow-hidden border-t-8 border-yellow-500">
                <div class="p-8 text-center bg-gray-900 text-white relative">
                    <h2 class="text-3xl font-bold mb-2 text-yellow-500">INFORME FINAL</h2>
                    <p class="text-sm text-gray-400">Auditor√≠a de Desempe√±o - UDAL TRADER</p>
                </div>
                
                <div class="p-8">
                    <div class="flex flex-col md:flex-row gap-8 items-center justify-center">
                        <div class="text-center w-full md:w-1/3">
                            <div id="badgeIcon" class="text-6xl mb-4 text-gray-300"></div>
                            <h3 id="rankTitle" class="text-xl font-bold text-blue-900 mb-1">...</h3>
                            <p class="text-xs text-gray-500" id="rankDesc">...</p>
                        </div>
                        <div class="w-full md:w-2/3 text-center md:text-left space-y-4">
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Capital Final</p>
                                <p class="text-4xl font-mono font-bold text-gray-800" id="finalNetWorth">$0.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Retorno (ROI)</p>
                                <p class="text-xl font-bold" id="finalROI">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <button onclick="location.reload()" class="bg-blue-900 text-white px-6 py-2 rounded text-sm font-bold hover:bg-blue-800">Cerrar Sistema</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- MODAL CR√âDITO -->
        <div id="loanModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl">
                <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center gap-2"><i class="fas fa-university"></i> Mercado de Cr√©dito</h3>
                <p class="text-xs text-gray-500 mb-4">Elige una instituci√≥n para apalancarte. El inter√©s se cobra diariamente. Solo puedes elegir uno.</p>
                
                <div class="space-y-3">
                    <div onclick="selectLoan('azteca')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group">
                        <div>
                            <p class="font-bold text-green-700">Banco Azteca (UDAL)</p>
                            <p class="text-xs text-gray-500">Monto: $500,000 | Tasa Diaria: 5%</p>
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded group-hover:bg-green-200">Elegir</span>
                    </div>
                    <div onclick="selectLoan('santander')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group">
                        <div>
                            <p class="font-bold text-red-700">Santander</p>
                            <p class="text-xs text-gray-500">Monto: $1,000,000 | Tasa Diaria: 3%</p>
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded group-hover:bg-red-200">Elegir</span>
                    </div>
                    <div onclick="selectLoan('bbva')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group">
                        <div>
                            <p class="font-bold text-blue-700">BBVA</p>
                            <p class="text-xs text-gray-500">Monto: $2,000,000 | Tasa Diaria: 1.5%</p>
                            <p class="text-[9px] text-red-500">* Requiere $1.2M Patrimonio</p>
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded group-hover:bg-blue-200">Elegir</span>
                    </div>
                </div>
                <button onclick="document.getElementById('loanModal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-500 text-xs font-bold border rounded hover:bg-gray-100">Cancelar</button>
            </div>
        </div>

        <!-- MODAL OPORTUNIDAD (SIDE HUSTLE) -->
        <div id="hustleModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur">
            <div class="bg-yellow-50 rounded-lg w-full max-w-sm p-6 shadow-[0_0_30px_rgba(234,179,8,0.5)] border-2 border-yellow-400 text-center">
                <div class="text-4xl mb-2">‚ö°</div>
                <h3 class="text-xl font-black text-yellow-800 mb-2 uppercase">Oportunidad Flash</h3>
                <p class="text-sm font-bold text-gray-800 mb-1" id="hustleTitle">...</p>
                <p class="text-xs text-gray-600 mb-4" id="hustleDesc">...</p>
                
                <div class="bg-white p-3 rounded border border-yellow-200 mb-4">
                    <p class="text-xs font-bold text-gray-500 uppercase">Inversi√≥n Requerida</p>
                    <p class="text-xl font-mono font-bold text-gray-800" id="hustleCost">$0</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('hustleModal').classList.add('hidden')" class="py-2 bg-gray-200 rounded text-xs font-bold text-gray-600">Ignorar</button>
                    <button onclick="executeHustle()" class="py-2 bg-yellow-500 text-white rounded text-xs font-bold hover:bg-yellow-600 shadow-lg">¬°Arriesgar!</button>
                </div>
                <p class="text-[9px] text-gray-400 mt-2 italic">Probabilidad de √©xito: 50%</p>
            </div>
        </div>

        <!-- MODAL COMPRA/VENTA -->
        <div id="tradeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur">
            <div class="bg-white p-6 rounded-lg w-80 shadow-2xl border-t-4 border-blue-900 relative">
                <h3 id="tradeAssetName" class="text-lg font-bold mb-1 text-blue-900">Orden de Mercado</h3>
                <p class="text-xs text-gray-500 mb-4">Cotizaci√≥n: <span id="tradeAssetPrice" class="text-black font-mono font-bold"></span></p>
                <div class="flex gap-2 mb-4">
                    <button onclick="setTradeMode('buy')" id="btnModeBuy" class="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white">COMPRAR</button>
                    <button onclick="setTradeMode('sell')" id="btnModeSell" class="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500">VENDER</button>
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Volumen (MXN)</label>
                    <input type="number" id="tradeAmount" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-gray-900 font-mono focus:border-blue-900 outline-none" placeholder="0.00">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeTradeModal()" class="flex-1 py-2 rounded border border-gray-300 text-gray-500 text-xs font-bold hover:bg-gray-100">CANCELAR</button>
                    <button onclick="executeTrade()" id="btnConfirmTrade" class="flex-1 py-2 rounded bg-blue-900 text-white font-bold text-xs hover:bg-blue-800 shadow">EJECUTAR</button>
                </div>
            </div>
        </div>

        <!-- MODAL CIERRE DEL D√çA (TOKEN) -->
        <div id="saveModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] p-4">
            <div class="bg-white p-6 rounded max-w-lg w-full text-center border-4 border-gray-800 shadow-[0_0_20px_rgba(255,255,255,0.5)]">
                
                <div id="pixelArtHeader" class="mb-4 flex justify-center text-4xl"></div>
                
                <h2 class="text-xl font-bold text-gray-800 mb-2 pixel-font text-xs leading-relaxed" id="endDayTitle">JORNADA FINALIZADA</h2>
                <p class="text-gray-600 text-xs mb-2" id="endDayMsg">Resultados del d√≠a.</p>
                <div id="daySummary" class="text-[10px] text-gray-500 mb-4 italic"></div>
                
                <p class="text-[10px] font-bold text-red-600 mb-1 uppercase">Importante:</p>
                <p class="text-[10px] text-gray-500 mb-3 text-justify px-4">
                    El sistema UDAL TRADER no guarda tu progreso en la nube por seguridad. 
                    El siguiente c√≥digo <strong>ES tu partida guardada</strong>. Si lo pierdes, pierdes tu dinero.
                </p>

                <div class="bg-gray-900 p-3 rounded mb-3 border-2 border-gray-600 text-left overflow-hidden">
                    <code id="generatedCode" class="text-green-400 retro-font text-[10px] break-all block select-all cursor-text">...</code>
                </div>
                
                <button onclick="copyCode()" class="text-xs text-blue-600 underline mb-4 hover:text-blue-800">Copiar Token</button>
                <button onclick="location.reload()" class="block w-full px-4 py-3 bg-red-700 text-white rounded font-bold hover:bg-red-800 pixel-font text-[10px]">SALIR DEL SISTEMA</button>
            </div>
        </div>

        <!-- LOGIN PROFESOR -->
        <div id="teacherLoginModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80]">
            <div class="bg-white p-6 rounded-lg max-w-sm w-full border-t-4 border-yellow-500">
                <h3 class="text-blue-900 font-bold text-lg mb-4">Acceso Docente</h3>
                <input type="password" id="teacherPwd" class="w-full border border-gray-300 p-2 rounded mb-4 text-black bg-gray-50" placeholder="Contrase√±a">
                <div class="flex justify-end gap-2">
                    <button onclick="document.getElementById('teacherLoginModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button>
                    <button onclick="checkTeacherLogin()" class="px-4 py-2 bg-blue-900 text-white rounded text-sm font-bold hover:bg-blue-800">Entrar</button>
                </div>
            </div>
        </div>

        <!-- PANEL PROFESOR -->
        <section id="teacherSection" class="w-full max-w-4xl card p-6 hidden mt-8 mb-12 border-yellow-500">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h2 class="text-xl font-bold text-blue-900">Auditor√≠a Docente</h2>
                <button onclick="location.reload()" class="text-xs bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 text-gray-700">Cerrar Sesi√≥n</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Token del Alumno:</p>
                    <textarea id="teacherInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 text-blue-900 retro-font text-xs h-32 focus:border-blue-900 outline-none mb-2"></textarea>
                    <button onclick="verifyStudentCode()" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 text-sm shadow">Auditar</button>
                </div>
                <div id="teacherResult" class="bg-gray-50 p-4 rounded border border-gray-200 text-sm h-full overflow-y-auto hidden"></div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-900 text-gray-500 py-4 text-center text-[10px] mt-auto">
        <p>¬© 2025 Dr. Julio C. G. Quintero. Todos los derechos reservados.</p>
        <p class="mt-1 opacity-50">Plataforma educativa UDAL TRADER.</p>
    </footer>

<script>
/* --- CONFIGURACI√ìN --- */
const MAX_DAYS = 7;
const INITIAL_CASH = 1000000;

const assetsDB = [
    // Indices y Divisas
    { id: 'ipc', name: 'IPC M√©xico', type: '√çndice', base: 54000, hist: [1, 1.01, 1.005, 0.98, 0.95, 0.96, 0.99] },
    { id: 'spx', name: 'S&P 500', type: '√çndice', base: 9500, hist: [1, 1.02, 1.03, 1.01, 0.90, 0.92, 0.95] },
    { id: 'usd', name: 'D√≥lar (USD)', type: 'Divisa', base: 19.80, hist: [1, 1.01, 1.03, 1.05, 1.10, 1.08, 1.07] },
    // Acciones
    { id: 'nvda', name: 'NVIDIA', type: 'Acci√≥n', base: 2800, hist: [1, 1.05, 1.12, 1.15, 0.70, 0.80, 0.95] },
    { id: 'amzn', name: 'Amazon', type: 'Acci√≥n', base: 3200, hist: [1, 0.98, 0.99, 1.02, 1.04, 1.06, 1.10] },
    { id: 'googl', name: 'Google', type: 'Acci√≥n', base: 3400, hist: [1, 1.01, 1.01, 1.02, 0.99, 1.01, 1.03] },
    { id: 'tsla', name: 'Tesla', type: 'Acci√≥n', base: 4100, hist: [1, 1.05, 1.02, 0.95, 0.90, 0.85, 1.15] },
    // Commodities
    { id: 'gold', name: 'Oro (Futuros)', type: 'Commodity', base: 35000, hist: [1, 1.01, 1.02, 1.04, 1.05, 1.06, 1.07] },
    { id: 'oil', name: 'Petr√≥leo WTI', type: 'Commodity', base: 1400, hist: [1, 1.05, 1.10, 1.15, 1.00, 0.90, 0.85] },
    // Renta Fija
    { id: 'pemex', name: 'Bonos PEMEX', type: 'Obligaci√≥n', base: 100, hist: [1, 0.99, 0.98, 0.95, 0.90, 0.85, 0.88] },
    { id: 'bimbo', name: 'Cert. BIMBO', type: 'Obligaci√≥n', base: 105, hist: [1, 1.001, 1.002, 1.003, 1.004, 1.005, 1.006] },
    { id: 'cetes', name: 'CETES 28', type: 'Bono Gov', base: 10, hist: [1, 1.002, 1.004, 1.006, 1.008, 1.010, 1.012] },
    // Cripto
    { id: 'btc', name: 'Bitcoin', type: 'Cripto', base: 1300000, hist: [1, 1.10, 1.20, 0.90, 0.85, 1.25, 1.40] }
];

/* --- NARRATIVAS --- */
const startScenarios = [
    { fin: ["Bolsa Mexicana toca m√°ximos.", "Superpeso fuerte.", "NVIDIA lidera rally."], eco: ["Confianza consumidor alta.", "Inversi√≥n r√©cord.", "Tech imparables."], hint: "Mercado euf√≥rico. Tendencia alcista." },
    { fin: ["Miedo a recesi√≥n EE.UU.", "Petr√≥leo cae.", "Refugio en bonos."], eco: ["PIB desacelera.", "Alerta construcci√≥n.", "Oro sube."], hint: "Incertidumbre. Busca seguridad." },
    { fin: ["Bitcoin rompe barreras.", "Fiebre IA.", "Startups ganan."], eco: ["¬øBurbuja?", "Riesgo cripto.", "Volatilidad."], hint: "Alto riesgo, alta recompensa." }
];
const fixedNews = [
    null, null,
    { fin: ["Regulaci√≥n Tech Europa.", "Amazon invierte.", "PEMEX presionado."], eco: ["Multa a NVIDIA.", "Deuda PEMEX.", "Incertidumbre."], hint: "Cuidado con NVIDIA y PEMEX." },
    { fin: ["Inflaci√≥n repunta.", "Tasas altas.", "IPC baja."], eco: ["Banxico firme.", "BIMBO s√≥lido.", "CETES atractivos."], hint: "Deuda corporativa s√≥lida es refugio." },
    { fin: ["¬°ALERTA ROJA!", "NVIDIA fraude.", "S&P 500 cae."], eco: ["P√°nico Wall St.", "Ventas masivas.", "BTC tambalea."], hint: "¬°VENDE RIESGO! Busca liquidez." },
    { fin: ["Estabilizaci√≥n.", "Oportunidades compra.", "D√≥lar sube."], eco: ["Cazadores ofertas.", "NVIDIA m√≠nimos.", "Refugio divisas."], hint: "¬øRebote t√©cnico? Compra barato." },
    { fin: ["Rescate deuda.", "Bitcoin rebota.", "Amazon sorprende."], eco: ["Hacienda recompra.", "Cripto brilla.", "Consumo fuerte."], hint: "Consumo y Cripto recuperan." },
    { fin: ["Cierre fiscal.", "Auditor√≠a final.", "Mixto."], eco: ["Fin ciclo.", "Balances.", "Expectativa."], hint: "Asegura ganancias. Cierra libros." }
];

/* --- SIDE HUSTLES --- */
const hustles = [
    { title: "Lote de Vapes", desc: "Un contacto vende mercanc√≠a china 'gris' a precio de remate.", cost: 50000 },
    { title: "Puesto de Tacos", desc: "Traspaso de local frente a la universidad.", cost: 100000 },
    { title: "Pr√©stamo Personal", desc: "Un compa√±ero necesita dinero urgente. Pagar√© firmado.", cost: 20000 },
    { title: "NFTs de Monos", desc: "Colecci√≥n de arte digital. Dicen que subir√°.", cost: 10000 }
];

// STATE
let gameState = {
    name: "", day: 1, cash: INITIAL_CASH, portfolio: {}, accessLog: [],
    bypassed: 0, blackSwans: {}, narrativeId: 0,
    expertConsulted: false, // flag diario
    loan: { bank: null, amount: 0, rate: 0 },
    activeHustle: null // current hustle available
};

assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
let currentNewsSource = 'fin'; 

/* --- INTERFAZ --- */
function toggleLoginMode(mode) {
    const btnNew = document.getElementById('tabNew');
    const btnLoad = document.getElementById('tabLoad');
    const formNew = document.getElementById('newGameForm');
    const formLoad = document.getElementById('loadGameForm');
    if(mode === 'new') { formNew.classList.remove('hidden'); formLoad.classList.add('hidden'); btnNew.classList.replace('text-gray-400', 'text-blue-900'); btnNew.classList.add('border-blue-900'); btnLoad.classList.replace('text-blue-900', 'text-gray-400'); btnLoad.classList.remove('border-blue-900'); }
    else { formNew.classList.add('hidden'); formLoad.classList.remove('hidden'); btnLoad.classList.replace('text-gray-400', 'text-blue-900'); btnLoad.classList.add('border-blue-900'); btnNew.classList.replace('text-blue-900', 'text-gray-400'); btnNew.classList.remove('border-blue-900'); }
}

function startSequence() {
    const name = document.getElementById('studentName').value.trim();
    if(!name) return alert("Nombre requerido");
    gameState.name = name; gameState.day = 1; gameState.cash = INITIAL_CASH; gameState.portfolio = {};
    assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
    gameState.accessLog = [new Date().toLocaleString()];
    gameState.narrativeId = Math.floor(Math.random() * 3);
    
    // Activar Gu√≠a si checkbox
    if(document.getElementById('guideCheck').checked) activateGuide();
    
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('gameSection').classList.remove('hidden');
    renderGame();
}

function activateGuide() {
    document.querySelectorAll('.help-icon').forEach(el => el.classList.remove('hidden'));
}

/* --- GAME LOGIC --- */
function renderGame() {
    document.getElementById('displayDay').innerText = `D√≠a ${gameState.day} / ${MAX_DAYS}`;
    document.getElementById('displayCash').innerText = fmtMoney(gameState.cash);
    
    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0) * getPrice(a, gameState.day));
    const netWorth = gameState.cash + portVal - gameState.loan.amount; // Restar deuda del patrimonio
    
    document.getElementById('displayPortfolioVal').innerText = fmtMoney(portVal);
    document.getElementById('displayNetWorth').innerText = fmtMoney(netWorth);

    // Expert Button State
    const btnExp = document.getElementById('btnExpert');
    const cost = netWorth < INITIAL_CASH ? 1000 : 5000;
    document.getElementById('expertCost').innerText = fmtMoney(cost);
    if(gameState.expertConsulted) {
        btnExp.classList.remove('bg-gray-200'); btnExp.classList.add('bg-green-100', 'text-green-800');
        btnExp.innerHTML = '<i class="fas fa-check"></i> CONSULTADO';
    } else {
        btnExp.classList.add('bg-gray-200'); btnExp.classList.remove('bg-green-100', 'text-green-800');
        btnExp.innerHTML = `<i class="fas fa-chart-pie"></i> CONSULTOR√çA (<span id="expertCost">${fmtMoney(cost)}</span>)`;
    }

    // Loan Status
    if(gameState.loan.amount > 0) {
        document.getElementById('loanStatus').classList.remove('hidden');
        document.getElementById('btnLoan').classList.add('hidden');
    }

    // Hustle Button (Day 3 & 6)
    if((gameState.day === 3 || gameState.day === 6) && !gameState.activeHustle) {
        document.getElementById('btnHustle').classList.remove('hidden');
    } else {
        document.getElementById('btnHustle').classList.add('hidden');
    }

    renderNews();
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('marketTableBody');
    tbody.innerHTML = '';
    assetsDB.forEach(a => {
        const price = getPrice(a, gameState.day);
        const qty = gameState.portfolio[a.id] || 0;
        let status = '<span class="text-gray-400">‚ñ¨</span>';
        const swanMult = (gameState.blackSwans && gameState.blackSwans[a.id]) !== undefined ? gameState.blackSwans[a.id] : null;
        
        if (swanMult !== null) {
            if(swanMult > 1.2) status = 'üöÄ MOON';
            else if (swanMult < 0.1) status = 'üíÄ CRASH';
            else if (swanMult < 1) status = 'üîª DOWN';
        } else if(gameState.day > 1) {
            const prev = getPrice(a, gameState.day - 1);
            const change = (price - prev) / prev;
            if(change > 0.03) status = '<span class="text-green-600 font-bold">‚ñ≤‚ñ≤</span>';
            else if(change > 0) status = '<span class="text-green-500">‚ñ≤</span>';
            else if(change < -0.03) status = '<span class="text-red-600 font-bold">‚ñº‚ñº</span>';
            else if(change < 0) status = '<span class="text-red-500">‚ñº</span>';
        }

        const tr = document.createElement('tr');
        tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-100";
        tr.innerHTML = `
            <td class="px-3 py-3 font-bold text-blue-900 text-xs">${a.name}</td>
            <td class="px-3 py-3 text-center text-xs font-bold">${status}</td>
            <td class="px-3 py-3 text-right font-mono text-xs text-gray-700 font-bold">${fmtMoney(price)}</td>
            <td class="px-3 py-3 text-center text-xs text-gray-500">${qty.toFixed(2)}</td>
            <td class="px-3 py-3 text-center">
                <button onclick="openTrade('${a.id}')" class="bg-blue-900 hover:bg-blue-800 text-white text-[10px] px-3 py-1 rounded font-bold shadow" ${swanMult !== null && swanMult < 0.1 ? 'disabled class="opacity-50"' : ''}>OPERAR</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function getPrice(asset, day) {
    if(day === 0) return asset.base;
    let multiplier = 1;
    if(gameState.blackSwans && gameState.blackSwans[asset.id] !== undefined) multiplier = gameState.blackSwans[asset.id];
    let idx = day - 1;
    if(idx >= asset.hist.length) idx = asset.hist.length - 1;
    return asset.base * asset.hist[idx] * multiplier;
}

function renderNews() {
    let data;
    if(gameState.day === 1) data = startScenarios[gameState.narrativeId || 0];
    else data = fixedNews[gameState.day] || { fin:[], eco:[], hint:"" };
    
    const items = currentNewsSource === 'fin' ? data.fin : data.eco;
    const title = currentNewsSource === 'fin' ? 'EL FINANCIERO' : 'EL ECONOMISTA';
    const color = currentNewsSource === 'fin' ? 'text-orange-700' : 'text-blue-900';
    
    document.getElementById('newsTitle').innerText = title;
    document.getElementById('newsTitle').className = `headline-font font-black text-2xl leading-none ${color}`;
    
    const feed = document.getElementById('newsFeed');
    feed.innerHTML = '';
    items.forEach(txt => {
        const borderCol = title.includes('FINANCIERO') ? 'border-orange-400' : 'border-blue-900';
        feed.innerHTML += `<div class="border-l-4 ${borderCol} pl-3 py-1"><p class="font-serif font-bold text-gray-800 text-xs leading-tight">${txt}</p></div>`;
    });
}
function toggleNewsSource() { currentNewsSource = currentNewsSource === 'fin' ? 'eco' : 'fin'; renderNews(); }

/* --- EXPERTO --- */
function consultExpert() {
    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0) * getPrice(a, gameState.day));
    const net = gameState.cash + portVal;
    const cost = net < INITIAL_CASH ? 1000 : 5000;
    
    // Check if already paid
    if(gameState.expertConsulted) {
        showExpertHint();
        return;
    }

    if(gameState.cash < cost) return alert("Saldo insuficiente.");
    
    // First time warning
    if(!confirm(`‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEst√°s a punto de contratar un servicio de consultor√≠a.\n\nCosto: ${fmtMoney(cost)}\nFiabilidad: 90%\n\n¬øAutorizar cargo √∫nico por el d√≠a de hoy?`)) return;
    
    gameState.cash -= cost;
    gameState.expertConsulted = true;
    showExpertHint();
    renderGame();
}

function showExpertHint() {
    let nextHint = "Mant√©n la cautela.";
    if(gameState.day < MAX_DAYS) {
        const nextData = fixedNews[gameState.day + 1];
        if(nextData) nextHint = nextData.hint;
    }
    const resBox = document.getElementById('expertResult');
    resBox.innerText = `ANALISTA: "${nextHint}"`;
    resBox.classList.remove('hidden');
}

/* --- CR√âDITO --- */
function openLoanModal() { document.getElementById('loanModal').classList.remove('hidden'); }
function selectLoan(bank) {
    let amount = 0, rate = 0, name = "";
    
    if(bank === 'azteca') { amount = 500000; rate = 0.05; name = "Banco Azteca"; }
    else if(bank === 'santander') { amount = 1000000; rate = 0.03; name = "Santander"; }
    else if(bank === 'bbva') {
        let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0) * getPrice(a, gameState.day));
        if((gameState.cash + portVal) < 1200000) return alert("BBVA rechaza tu solicitud: Patrimonio insuficiente.");
        amount = 2000000; rate = 0.015; name = "BBVA";
    }

    if(confirm(`¬øContratar cr√©dito con ${name}?\n\nRecibes: ${fmtMoney(amount)}\nInter√©s Diario: ${(rate*100)}%\n\nEl inter√©s se cobrar√° autom√°ticamente al cierre de cada d√≠a.`)) {
        gameState.loan = { bank: bank, amount: amount, rate: rate };
        gameState.cash += amount;
        document.getElementById('loanModal').classList.add('hidden');
        renderGame();
    }
}

/* --- SIDE HUSTLES --- */
function openHustleModal() {
    const hustle = hustles[Math.floor(Math.random() * hustles.length)];
    gameState.activeHustle = hustle; // Store temp
    
    document.getElementById('hustleTitle').innerText = hustle.title;
    document.getElementById('hustleDesc').innerText = hustle.desc;
    document.getElementById('hustleCost').innerText = fmtMoney(hustle.cost);
    document.getElementById('hustleModal').classList.remove('hidden');
}

function executeHustle() {
    const h = gameState.activeHustle;
    if(!h) return;
    if(gameState.cash < h.cost) return alert("No tienes liquidez suficiente.");
    
    gameState.cash -= h.cost;
    document.getElementById('hustleModal').classList.add('hidden');
    document.getElementById('btnHustle').classList.add('hidden'); // Hide button
    
    // 50/50 Chance
    const success = Math.random() > 0.5;
    let profit = 0;
    
    if(success) {
        profit = h.cost * 2; // Double money
        gameState.cash += profit;
        alert(`üéâ ¬°√âXITO! üéâ\nEl negocio funcion√≥ de maravilla. Recuperaste tu inversi√≥n y ganaste ${fmtMoney(h.cost)} extra.`);
    } else {
        alert(`üìâ FRACASO üìâ\nEl negocio sali√≥ mal. Perdiste toda la inversi√≥n de ${fmtMoney(h.cost)}.`);
    }
    
    renderGame();
}

/* --- EVENTOS (CISNES) --- */
function triggerBlackSwan() {
    if(gameState.day < 3) return;
    assetsDB.forEach(a => {
        if(Math.random() < 0.04 && gameState.blackSwans[a.id] === undefined) {
            if(a.id === 'pemex') { alert(`üá≤üáΩ ¬°MISS UNIVERSO! üá≤üáΩ\nLa representante de M√©xico gan√≥. Bonos PEMEX suben por puro orgullo nacional.`); gameState.blackSwans[a.id] = 1.5; }
            else if (a.id === 'nvda') { alert(`üìâ PELEA DE CEOS üìâ\nEl CEO de NVIDIA perdi√≥ una pelea en jaula. Acciones caen.`); gameState.blackSwans[a.id] = 0.6; }
            else if (a.id === 'amzn') { alert(`üì¶ OXYGEN PRIME üì¶\nAmazon patenta el aire. Acciones suben.`); gameState.blackSwans[a.id] = 1.3; }
            else if (a.type === 'Cripto') { alert(`üíÄ RUG PULL üíÄ\nCEO 'desaparecido' con las claves. Valor cero.`); gameState.blackSwans[a.id] = 0.00; }
            else if (a.type.includes('Obligaci√≥n')) { alert(`üíÄ DEFAULT üíÄ\nPagos suspendidos.`); gameState.blackSwans[a.id] = 0.2; }
        }
    });
}

/* --- TRADE SYSTEM --- */
let currTradeId = null; let tradeMode = 'buy';
function openTrade(id) {
    currTradeId = id; tradeMode = 'buy';
    const asset = assetsDB.find(x => x.id === id);
    const price = getPrice(asset, gameState.day);
    const qty = gameState.portfolio[id] || 0;
    document.getElementById('tradeModal').classList.remove('hidden'); document.getElementById('tradeModal').classList.add('flex');
    document.getElementById('tradeAssetName').innerText = asset.name;
    document.getElementById('tradeAssetPrice').innerText = fmtMoney(price);
    document.getElementById('tradeAmount').value = '';
    setTradeMode('buy');
}
function setTradeMode(m) { tradeMode = m; const bB = document.getElementById('btnModeBuy'); const bS = document.getElementById('btnModeSell'); if(m==='buy') { bB.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white"; bS.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500"; } else { bS.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white"; bB.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500"; } }
function closeTradeModal() { document.getElementById('tradeModal').classList.add('hidden'); document.getElementById('tradeModal').classList.remove('flex'); }
function executeTrade() {
    const amt = parseFloat(document.getElementById('tradeAmount').value);
    if(!amt || amt<=0) return;
    const asset = assetsDB.find(x => x.id === currTradeId);
    const price = getPrice(asset, gameState.day);
    if(tradeMode === 'buy') {
        if(amt > gameState.cash) return alert("Liquidez insuficiente.");
        gameState.cash -= amt;
        if(!gameState.portfolio[currTradeId]) gameState.portfolio[currTradeId] = 0;
        gameState.portfolio[currTradeId] += amt/price;
    } else {
        const currVal = (gameState.portfolio[currTradeId]||0)*price;
        if(amt > currVal+1) return alert("Posici√≥n insuficiente.");
        if(Math.abs(amt-currVal)<10) { gameState.cash+=currVal; gameState.portfolio[currTradeId]=0; }
        else { gameState.cash+=amt; gameState.portfolio[currTradeId]-=amt/price; }
    }
    closeTradeModal(); renderGame();
}

/* --- END DAY --- */
function endDay() {
    if(!confirm("¬øCerrar libros del d√≠a?")) return;
    
    // Cobrar Inter√©s Cr√©dito
    let loanMsg = "";
    if(gameState.loan.amount > 0) {
        const interest = gameState.loan.amount * gameState.loan.rate;
        gameState.cash -= interest;
        loanMsg = `Intereses pagados: -${fmtMoney(interest)}`;
        if(gameState.cash < 0) alert("‚ö†Ô∏è ALERTA DE LIQUIDEZ ‚ö†Ô∏è\nLos intereses bancarios han dejado tu cuenta en negativo. Vende activos urgentemente.");
    }

    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, gameState.day));
    const todayNet = gameState.cash + portVal - gameState.loan.amount;
    
    let art = "üòê";
    const roi = (todayNet - INITIAL_CASH);
    if(roi > 50000) art = "üöÄ"; else if (roi > 0) art = "üìà"; else if (roi < -50000) art = "üíÄ"; else if (roi < 0) art = "üìâ";

    document.getElementById('pixelArtHeader').innerHTML = `<span class="transform scale-150 inline-block">${art}</span>`;
    document.getElementById('endDayMsg').innerText = roi >= 0 ? `Ganancia: +${fmtMoney(roi)}` : `P√©rdida: ${fmtMoney(roi)}`;
    document.getElementById('daySummary').innerText = loanMsg;

    if(gameState.day >= MAX_DAYS) { showResults(); return; }

    let nextState = JSON.parse(JSON.stringify(gameState));
    nextState.day++;
    nextState.expertConsulted = false; // Reset expert
    nextState.activeHustle = null; // Clear hustle
    nextState.accessLog.push(new Date().toLocaleString());
    
    const code = "UDAL-" + btoa(JSON.stringify(nextState)).split('').reverse().join('');
    document.getElementById('generatedCode').innerText = code;
    document.getElementById('saveModal').classList.remove('hidden');
    document.getElementById('saveModal').classList.add('flex');
}

/* --- LOAD & RESULTS --- */
function showResults() {
    document.getElementById('gameSection').classList.add('hidden'); document.getElementById('resultsSection').classList.remove('hidden'); document.getElementById('resultsSection').classList.add('flex');
    let portVal=0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, MAX_DAYS));
    const finalVal = gameState.cash + portVal - gameState.loan.amount;
    const roi = ((finalVal - INITIAL_CASH) / INITIAL_CASH) * 100;
    document.getElementById('finalNetWorth').innerText = fmtMoney(finalVal);
    document.getElementById('finalROI').innerText = roi.toFixed(2) + "%";
    const icon = document.getElementById('badgeIcon'); const title = document.getElementById('rankTitle'); const desc = document.getElementById('rankDesc');
    if(finalVal > 1200000) { icon.innerHTML = 'üëë'; title.innerText = "MAGNATE"; desc.innerText = "Dominaste el mercado."; }
    else if (finalVal > 1050000) { icon.innerHTML = 'üíº'; title.innerText = "EJECUTIVO"; desc.innerText = "Buen rendimiento."; }
    else if (finalVal > 1000000) { icon.innerHTML = 'üòê'; title.innerText = "AHORRADOR"; desc.innerText = "No perdiste dinero."; }
    else { icon.innerHTML = 'üìâ'; title.innerText = "QUIEBRA"; desc.innerText = "El mercado gana esta vez."; }
}

function loadGame() {
    let code = document.getElementById('saveCodeInput').value.trim();
    let bypass = false; if(code.startsWith("4242UDAL")) { bypass = true; code = code.substring(4); }
    try {
        const str = atob(code.replace("UDAL-","").split('').reverse().join(''));
        const data = JSON.parse(str);
        if(!data.accessLog) data.accessLog = []; data.accessLog.push(new Date().toLocaleString() + " (Login)");
        // Restore defaults if older version
        if(!data.loan) data.loan = {amount:0, rate:0};
        gameState = data;
        triggerBlackSwan();
        if(gameState.day > MAX_DAYS) showResults(); else startGame();
    } catch(e) { alert("Token corrupto."); }
}

function copyCode() { navigator.clipboard.writeText(document.getElementById('generatedCode').innerText); alert("Copiado"); }
function fmtMoney(n) { return "$" + n.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}); }

// DOCENTE
function checkTeacherLogin() { if(document.getElementById('teacherPwd').value === "udalintrader") { document.getElementById('teacherLoginModal').classList.add('hidden'); document.getElementById('teacherSection').classList.remove('hidden'); } }
function showTeacherLogin() { document.getElementById('teacherLoginModal').classList.remove('hidden'); document.getElementById('teacherLoginModal').classList.add('flex'); }
function verifyStudentCode() {
    let code = document.getElementById('teacherInput').value.trim(); if(code.startsWith("4242UDAL")) code = code.substring(4);
    try {
        const data = JSON.parse(atob(code.replace("UDAL-","").split('').reverse().join('')));
        let total = data.cash; assetsDB.forEach(a => { let idx = (data.day > 1) ? data.day - 2 : 0; total += (data.portfolio[a.id]||0) * (a.base * a.hist[idx]); });
        if(data.loan) total -= data.loan.amount;
        let logs = data.accessLog ? data.accessLog.join('<br>') : "Sin datos";
        document.getElementById('teacherResult').classList.remove('hidden');
        document.getElementById('teacherResult').innerHTML = `<p class="font-bold text-blue-900">Alumno: ${data.name}</p><p>D√≠a Actual: ${data.day}</p><p class="text-xl font-bold text-green-700">${fmtMoney(total)}</p><div class="mt-2 text-[10px] text-gray-500 border-t pt-2"><strong>Log de Accesos:</strong><br>${logs}</div>`;
    } catch(e){ alert("Error al leer token"); }
}
</script>
</body>
</html>