<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDAL TRADER - Plataforma Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Montserrat:wght@400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,300&family=Playfair+Display:wght@700;900&family=Press+Start+2P&display=swap');
        
        :root { --udal-blue: #002855; --udal-red: #a51c30; --paper-bg: #fdfbf7; }

        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        .retro-font { font-family: 'Roboto Mono', monospace; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .serif-font { font-family: 'Merriweather', serif; }
        .headline-font { font-family: 'Playfair Display', serif; }
        
        .card { background-color: white; border-top: 4px solid var(--udal-blue); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .btn-udal { background-color: var(--udal-blue); color: white; transition: all 0.2s; }
        .btn-udal:hover { background-color: #0f172a; transform: translateY(-1px); }
        .btn-danger { background-color: var(--udal-red); color: white; }
        .btn-danger:hover { background-color: #7f1d1d; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Efecto Periódico */
        .newspaper { background-color: var(--paper-bg); border: 1px solid #d1d5db; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); position: relative; }
        .newspaper::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--udal-blue) 0%, var(--udal-red) 100%); }

        /* Tooltips */
        .help-icon { cursor: help; color: var(--udal-blue); margin-left: 5px; opacity: 0.7; }
        .help-icon:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 8px; border-radius: 4px; font-size: 10px; width: 220px; text-align: center; z-index: 100; pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); line-height: 1.4;
        }
        .relative-tip { position: relative; display: inline-block; }

        /* Scroll */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animación Oportunidad */
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .btn-opportunity { animation: pulse-gold 2s infinite; }

        /* Oregon Modal */
        .oregon-modal { background-color: #000; color: #33ff00; font-family: 'Press Start 2P', monospace; border: 4px double #33ff00; text-transform: uppercase; }
        .oregon-btn { border: 2px solid #33ff00; color: #33ff00; background: transparent; padding: 10px; cursor: pointer; transition: all 0.2s; font-size: 10px; }
        .oregon-btn:hover { background: #33ff00; color: #000; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-between relative">

    <!-- Header -->
    <header class="w-full bg-white shadow-md z-10 relative">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center bg-white border-2 border-blue-900 w-16 h-10 rounded shadow overflow-hidden">
                    <span class="text-blue-900 font-black text-lg tracking-tighter">UDAL</span>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-blue-900 tracking-tighter">SIMULADOR <span class="text-red-800">DE MERCADOS</span></h1>
                </div>
            </div>
            <button onclick="showTeacherLogin()" class="text-xs text-gray-400 hover:text-blue-900 transition-colors"><i class="fas fa-lock"></i> Acceso Docente</button>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center p-4 relative w-full max-w-7xl mx-auto">
        
        <!-- INTRO / LOGIN -->
        <section id="loginSection" class="w-full max-w-lg card p-8 mb-4 fade-in mt-8 relative">
            <div class="absolute -top-3 -right-3 bg-red-800 text-white text-[10px] font-bold px-2 py-1 rounded shadow transform rotate-6">v2.0 FINAL</div>
            
            <h2 class="text-xl font-bold mb-2 text-center text-blue-900">Acceso Estudiantes</h2>
            <p class="text-xs text-center text-gray-500 mb-6 px-4">Ingresa tu matrícula para validar tu identidad en el sistema.</p>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="toggleLoginMode('new')" id="tabNew" class="flex-1 py-2 text-blue-900 border-b-2 border-blue-900 font-bold text-sm">Nuevo Portafolio</button>
                <button onclick="toggleLoginMode('load')" id="tabLoad" class="flex-1 py-2 text-gray-400 text-sm hover:text-gray-600">Continuar Inversiones</button>
            </div>

            <!-- Nuevo Juego -->
            <div id="newGameForm">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Matrícula (9 Dígitos)</label>
                <input type="number" id="studentId" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-4 text-gray-800 focus:outline-none focus:border-blue-900 font-mono tracking-widest" placeholder="Ej. 100017415">
                
                <div class="flex items-center mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <input type="checkbox" id="guideCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                    <label for="guideCheck" class="ml-2 text-sm text-blue-900 font-semibold cursor-pointer">Activar Asistente de Interfaz (Día 1)</label>
                </div>

                <button onclick="startSequence()" class="w-full btn-udal font-bold py-3 rounded shadow-lg">VALIDAR Y ACCEDER</button>
            </div>

            <!-- Cargar Juego -->
            <div id="loadGameForm" class="hidden">
                <label class="block text-xs font-bold mb-1 text-gray-500 uppercase">Token de Acceso</label>
                <textarea id="saveCodeInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 mb-2 text-blue-900 retro-font text-xs h-24 focus:outline-none focus:border-blue-900" placeholder="Pega aquí tu token guardado..."></textarea>
                <button onclick="loadGame()" class="w-full btn-danger font-bold py-3 rounded shadow-lg">RESTAURAR SESIÓN</button>
            </div>
        </section>

        <!-- DASHBOARD JUEGO -->
        <section id="gameSection" class="w-full hidden fade-in">
            
            <div class="flex justify-between items-end mb-4 border-b border-gray-200 pb-2">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase">Operador Autorizado</p>
                    <h2 class="text-sm font-bold text-blue-900" id="operatorNameDisplay">...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400">Matrícula</p>
                    <p class="text-sm font-mono text-gray-600" id="operatorIdDisplay">...</p>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="statsBar">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-900 relative">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Jornada</p>
                        <i class="fas fa-question-circle help-icon" data-tip="Día actual de la simulación. Tienes 7 días para maximizar ganancias."></i>
                    </div>
                    <p class="text-2xl font-bold retro-font text-blue-900" id="displayDay">Día 1 / 7</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-600 relative">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Liquidez</p>
                        <i class="fas fa-question-circle help-icon" data-tip="Dinero en efectivo disponible para realizar compras o pagar deudas."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-green-700" id="displayCash">$1,000,000</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-purple-600 relative">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Inversiones</p>
                        <i class="fas fa-question-circle help-icon" data-tip="Valor total de tus acciones y activos si los vendieras hoy a precio de mercado."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-purple-700" id="displayPortfolioVal">$0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-gray-800 relative">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Patrimonio</p>
                        <i class="fas fa-question-circle help-icon" data-tip="Tu 'Score' Real: Efectivo + Inversiones - Deudas."></i>
                    </div>
                    <p class="text-xl font-bold retro-font text-gray-800" id="displayNetWorth">$1,000,000</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Sidebar -->
                <div class="lg:col-span-1 flex flex-col gap-4">
                    <!-- Periódico -->
                    <div id="newsSection" class="newspaper p-5 rounded relative">
                        <div class="border-b-2 border-black mb-3 pb-2 flex justify-between items-end">
                            <div>
                                <h3 class="headline-font font-black text-2xl text-black leading-none" id="newsTitle">EL FINANCIERO</h3>
                                <p class="text-[9px] text-gray-500 font-serif mt-1">INFORMACIÓN EN TIEMPO REAL</p>
                            </div>
                            <button onclick="toggleNewsSource()" class="text-[10px] border border-gray-400 px-2 py-1 rounded hover:bg-white transition-colors">
                                Fuente <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="newsFeed" class="space-y-4"></div>
                    </div>

                    <!-- Panel Servicios Financieros -->
                    <div class="bg-white border-t-4 border-gray-800 p-4 rounded shadow relative">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2"><i class="fas fa-briefcase"></i> Opciones</h3>
                            <i class="fas fa-question-circle help-icon" data-tip="Herramientas avanzadas para potenciar tu estrategia (o tu ruina)."></i>
                        </div>
                        
                        <div class="mb-3">
                            <button onclick="consultExpert()" id="btnExpert" class="w-full py-2 rounded font-bold text-xs shadow transition-colors flex justify-between items-center px-3 bg-gray-100 text-gray-700 hover:bg-gray-200">
                                <span><i class="fas fa-chart-pie"></i> Consultar Experto</span>
                                <span class="text-[9px] bg-gray-300 px-1 rounded" id="expertCostBadge">$5k</span>
                            </button>
                            <p id="expertResult" class="mt-1 text-[10px] hidden bg-yellow-100 p-2 rounded text-yellow-800 border-l-2 border-yellow-500 italic"></p>
                        </div>

                        <div class="mb-3">
                            <button onclick="openLoanModal()" id="btnLoan" class="w-full py-2 rounded font-bold text-xs shadow transition-colors flex justify-between items-center px-3 bg-gray-100 text-gray-700 hover:bg-gray-200">
                                <span><i class="fas fa-landmark"></i> Solicitar Crédito</span>
                                <span class="text-[9px] bg-gray-300 px-1 rounded">Único</span>
                            </button>
                            <div id="loanStatus" class="hidden flex justify-between items-center text-[10px] bg-red-50 text-red-800 p-2 rounded border border-red-100 mt-1 font-bold">
                                <span><i class="fas fa-check-circle"></i> Deuda Activa</span>
                                <button onclick="payLoan()" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-[9px]">LIQUIDAR</button>
                            </div>
                        </div>

                        <div>
                            <button onclick="openHustleModal()" id="btnHustle" class="w-full py-2 rounded font-bold text-xs shadow transition-colors flex justify-between items-center px-3 bg-yellow-500 text-white hover:bg-yellow-600 btn-opportunity">
                                <span><i class="fas fa-bolt"></i> Oportunidad Flash</span>
                                <span class="text-[9px] bg-yellow-700 px-1 rounded">Diario</span>
                            </button>
                            <div id="hustleStatus" class="hidden text-[10px] text-gray-400 text-center mt-1 italic">
                                Oportunidad agotada por hoy.
                            </div>
                        </div>
                    </div>

                    <!-- Botón Finalizar -->
                    <div class="bg-blue-900 p-5 rounded shadow text-white">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold">Cierre de Libros</h3>
                            <i class="fas fa-question-circle text-blue-300 text-[10px] cursor-help" title="Al cerrar el día, se calculan intereses, se actualizan precios y obtienes tu código de guardado."></i>
                        </div>
                        <p class="text-[10px] text-blue-200 mb-3">Consolida posiciones y avanza al siguiente periodo.</p>
                        <button onclick="endDay()" class="w-full py-3 bg-red-700 hover:bg-red-600 rounded font-bold shadow text-sm transition-colors border border-red-500">
                            EJECUTAR CIERRE DIARIO
                        </button>
                    </div>
                </div>

                <!-- Tabla de Mercado -->
                <div class="lg:col-span-2 bg-white rounded shadow overflow-hidden flex flex-col h-[600px]">
                    <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-blue-900 text-sm flex items-center gap-2">
                            <i class="fas fa-balance-scale"></i> Pizarra de Cotizaciones
                        </h3>
                        <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded">MXN</span>
                    </div>
                    
                    <div class="overflow-y-auto custom-scroll flex-grow">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 bg-gray-100">Instrumento</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Info</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Tendencia</th>
                                    <th class="px-3 py-3 text-right bg-gray-100">Precio</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Posición</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="marketTableBody" class="divide-y divide-gray-100">
                                <!-- Filas JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN RESULTADOS FINALES -->
        <section id="resultsSection" class="w-full max-w-4xl hidden fade-in mt-8">
            <div class="bg-white rounded-lg shadow-2xl overflow-hidden border-t-8 border-yellow-500">
                <div class="p-8 text-center bg-gray-900 text-white relative">
                    <h2 class="text-3xl font-bold mb-2 text-yellow-500">INFORME FINAL</h2>
                    <p class="text-sm text-gray-400">Auditoría de Desempeño - UDAL TRADER</p>
                </div>
                
                <div class="p-8">
                    <div class="flex flex-col md:flex-row gap-8 items-center justify-center">
                        <div class="text-center w-full md:w-1/3">
                            <div id="badgeIcon" class="text-6xl mb-4 text-gray-300"></div>
                            <h3 id="rankTitle" class="text-xl font-bold text-blue-900 mb-1">...</h3>
                            <p class="text-xs text-gray-500" id="rankDesc">...</p>
                        </div>
                        <div class="w-full md:w-2/3 text-center md:text-left space-y-4">
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Capital Final</p>
                                <p class="text-4xl font-mono font-bold text-gray-800" id="finalNetWorth">$0.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Retorno (ROI)</p>
                                <p class="text-xl font-bold" id="finalROI">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <button onclick="location.reload()" class="bg-blue-900 text-white px-6 py-2 rounded text-sm font-bold hover:bg-blue-800">Cerrar Sistema</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- MODAL INFO FICHA TÉCNICA -->
        <div id="infoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl border-t-4 border-blue-900">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-blue-900" id="infoTitle">Nombre Activo</h3>
                    <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold uppercase" id="infoType">Acción</span>
                </div>
                
                <div class="mb-4 text-sm text-gray-700 leading-relaxed border-b border-gray-100 pb-4" id="infoDesc">
                    <!-- Descripción larga -->
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Nivel de Riesgo</p>
                        <p class="text-sm font-bold text-red-700" id="infoRisk">Alto</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Volatilidad</p>
                        <p class="text-sm font-bold text-orange-600" id="infoVol">Media</p>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400 mb-4">
                    <p class="text-[10px] text-yellow-800 uppercase font-bold flex items-center gap-1"><i class="fas fa-lightbulb"></i> Consejo de Mercado:</p>
                    <p class="text-xs text-gray-600 italic mt-1" id="infoTip"></p>
                </div>

                <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="w-full py-2 text-xs font-bold bg-blue-900 text-white rounded hover:bg-blue-800">Cerrar Ficha Técnica</button>
            </div>
        </div>

        <!-- MODAL CRÉDITO -->
        <div id="loanModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl"><h3 class="text-xl font-bold text-blue-900 mb-4"><i class="fas fa-university"></i> Mercado de Crédito</h3><p class="text-xs text-gray-500 mb-4">Tasa fija diaria. Plazo forzoso 7 días (o liquidación anticipada).</p><div class="space-y-3"><div onclick="selectLoan('azteca')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-green-700">Banco Azteca</p><p class="text-xs text-gray-500">300k | Tasa 4%</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div><div onclick="selectLoan('santander')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-red-700">Santander</p><p class="text-xs text-gray-500">500k | Tasa 2.5%</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div><div onclick="selectLoan('bbva')" class="border p-3 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center group"><div><p class="font-bold text-blue-700">BBVA</p><p class="text-xs text-gray-500">1M | Tasa 1.2%</p><p class="text-[9px] text-red-500">* Req: $1.2M Patrimonio</p></div><span class="text-xs bg-gray-200 px-2 py-1 rounded">Elegir</span></div></div><button onclick="document.getElementById('loanModal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-500 text-xs font-bold border rounded hover:bg-gray-100">Cancelar</button></div></div>

        <!-- MODAL OPORTUNIDAD -->
        <div id="hustleModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur"><div class="bg-yellow-50 rounded-lg w-full max-w-sm p-6 shadow-2xl border-2 border-yellow-400 text-center"><h3 class="text-xl font-black text-yellow-800 mb-2">OPORTUNIDAD</h3><p class="text-sm font-bold text-gray-800 mb-1" id="hustleTitle"></p><p class="text-xs text-gray-600 mb-4" id="hustleDesc"></p><div class="bg-white p-3 rounded border border-yellow-200 mb-4"><p class="text-xs font-bold text-gray-500 uppercase">Inversión</p><p class="text-xl font-mono font-bold text-gray-800" id="hustleCost"></p></div><div class="grid grid-cols-2 gap-3"><button onclick="document.getElementById('hustleModal').classList.add('hidden')" class="py-2 bg-gray-200 rounded text-xs font-bold text-gray-600">Ignorar</button><button onclick="executeHustle()" class="py-2 bg-yellow-500 text-white rounded text-xs font-bold hover:bg-yellow-600 shadow-lg">¡Arriesgar!</button></div></div></div>

        <!-- MODAL COMPRA/VENTA -->
        <div id="tradeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur"><div class="bg-white p-6 rounded-lg w-80 shadow-2xl border-t-4 border-blue-900 relative"><h3 id="tradeAssetName" class="text-lg font-bold mb-1 text-blue-900">Orden</h3><p class="text-xs text-gray-500 mb-2">Precio: <span id="tradeAssetPrice" class="text-black font-mono font-bold"></span></p><div class="bg-gray-100 p-2 rounded mb-4 text-[10px] text-gray-600 flex justify-between"><span>Tienes: <b id="tradeOwnedQty">0</b> u.</span><span>Valor: <b id="tradeOwnedVal">$0</b></span></div><div class="flex gap-2 mb-4"><button onclick="setTradeMode('buy')" id="btnModeBuy" class="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white">COMPRAR</button><button onclick="setTradeMode('sell')" id="btnModeSell" class="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500">VENDER</button></div><div class="mb-4"><label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Monto (MXN)</label><input type="number" id="tradeAmount" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-gray-900 font-mono focus:border-blue-900 outline-none" placeholder="0.00"></div><div class="flex gap-2"><button onclick="closeTradeModal()" class="flex-1 py-2 rounded border border-gray-300 text-gray-500 text-xs font-bold hover:bg-gray-100">CANCELAR</button><button onclick="executeTrade()" class="flex-1 py-2 rounded bg-blue-900 text-white font-bold text-xs hover:bg-blue-800 shadow">EJECUTAR</button></div></div></div>

        <!-- MODAL CIERRE DEL DÍA (OREGON STYLE) -->
        <div id="saveModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[70] p-4">
            <div class="w-full max-w-lg text-center border-4 border-green-500 p-6 bg-black oregon-modal">
                <div id="pixelArtHeader" class="text-4xl mb-4"></div>
                
                <h2 class="text-xl font-bold mb-4 uppercase tracking-widest text-green-500" id="endDayTitle">DÍA TERMINADO</h2>
                
                <p class="text-xs mb-4 leading-relaxed" id="endDayMsg"></p>
                <p class="text-[10px] text-green-700 italic mb-4" id="endDayIrony"></p>
                
                <div class="border border-green-900 p-2 mb-4 text-xs text-left" id="daySummary"></div>
                
                <p class="text-[10px] mb-2 uppercase blink text-red-500">¡COPIA TU CÓDIGO!</p>
                <div class="bg-green-900/20 p-3 rounded mb-4 border border-green-700 text-left overflow-hidden break-all">
                    <code id="generatedCode" class="text-[10px] select-all cursor-text text-white font-mono">...</code>
                </div>
                
                <button onclick="copyCode()" class="oregon-btn w-full mb-2">COPIAR AL PORTAPAPELES</button>
                <button onclick="location.reload()" class="oregon-btn w-full text-red-500 border-red-500 hover:bg-red-900 hover:text-white">SALIR DEL SISTEMA</button>
            </div>
        </div>
        
        <!-- EXPERT MODAL -->
        <div id="expertModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl">
                <h3 class="text-lg font-bold text-blue-900 mb-4">Selecciona un Analista</h3>
                <div class="space-y-2">
                    <button onclick="buyAdvice('junior')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">El Pasante</span><br><span class="text-[10px] text-gray-500">Poco fiable, pero barato.</span></div><span class="font-bold text-green-700">$500</span></button>
                    <button onclick="buyAdvice('senior')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">Analista Senior</span><br><span class="text-[10px] text-gray-500">Estudios de mercado sólidos.</span></div><span class="font-bold text-blue-700">$3,000</span></button>
                    <button onclick="buyAdvice('insider')" class="w-full p-3 border rounded hover:bg-gray-50 text-left flex justify-between"><div><span class="font-bold text-sm">El "Insider"</span><br><span class="text-[10px] text-gray-500">Información privilegiada (Ilegalmente buena).</span></div><span class="font-bold text-purple-700">$10,000</span></button>
                </div>
                <button onclick="document.getElementById('expertModal').classList.add('hidden')" class="mt-4 w-full py-2 text-xs text-gray-500">Cancelar</button>
            </div>
        </div>

        <!-- Teacher Login/Panel (Same) -->
        <div id="teacherLoginModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80]"><div class="bg-white p-6 rounded-lg max-w-sm w-full border-t-4 border-yellow-500"><h3 class="text-blue-900 font-bold text-lg mb-4">Acceso Docente</h3><input type="password" id="teacherPwd" class="w-full border border-gray-300 p-2 rounded mb-4 text-black bg-gray-50" placeholder="Contraseña"><div class="flex justify-end gap-2"><button onclick="document.getElementById('teacherLoginModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button><button onclick="checkTeacherLogin()" class="px-4 py-2 bg-blue-900 text-white rounded text-sm font-bold hover:bg-blue-800">Entrar</button></div></div></div>
        <section id="teacherSection" class="w-full max-w-4xl card p-6 hidden mt-8 mb-12 border-yellow-500"><div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4"><h2 class="text-xl font-bold text-blue-900">Auditoría Docente</h2><button onclick="location.reload()" class="text-xs bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Cerrar Sesión</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><p class="text-xs text-gray-500 mb-2 font-bold uppercase">Token del Alumno:</p><textarea id="teacherInput" class="w-full bg-gray-50 border border-gray-300 rounded p-3 text-blue-900 retro-font text-xs h-32 focus:border-blue-900 outline-none mb-2"></textarea><button onclick="verifyStudentCode()" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 text-sm shadow">Auditar</button></div><div id="teacherResult" class="bg-gray-50 p-4 rounded border border-gray-200 text-sm h-full overflow-y-auto hidden"></div></div></section>

    </main>

    <footer class="bg-gray-900 text-gray-500 py-4 text-center text-[10px] mt-auto">
        <p>© 2025 Dr. Julio C. G. Quintero. Todos los derechos reservados.</p>
        <p class="mt-1 opacity-50">Plataforma educativa UDAL TRADER.</p>
    </footer>

<script>
/* --- STUDENT DATABASE --- */
const STUDENT_DB={"100017415":"AVELINO MATEO XIMENA DANIELA","100017697":"BAEZ ROSALES ANGEL HERSAI","100017904":"CARRILLO CASTELAN FERNANDA HARET","100017657":"CATAL LUCAS SANDRA","100018025":"CRUZ LUCAS AIDE NATIVIDAD","100017729":"CUAYA FUENTES ALEX","100018128":"FERRER RODRIGUEZ XIMENA","100017907":"GAONA SORIA ISAAC MARIANO","100017651":"GARCIA ALVAREZ SANTIAGO","100017652":"GIL MARTINEZ BERENICE","100017370":"HERNANDEZ CORTES FATIMA","100018166":"HILARIO CASTAÑEDA ULISES","100017271":"MENA LORENZO OSCAR URIEL","100017869":"MERINO HERNANDEZ MARICRUZ","100018056":"MOCTEZUMA ORTEGA ARIEL","100017497":"MOLINA ENRIQUEZ RENE","100017665":"MORALES BELLO VANESSA","100017775":"MORALES GUTIEREZ ISAAC","100018096":"MORALES POBLANO EMILIO","100018164":"MUÑOZ CASTAÑEDA VALERIA","100017878":"NAVA FLORES SAUL EDUARDO","100017312":"NAVA MONTIEL CAMILA","100018099":"RAMIREZ CARREON EVA SOFIA","100018064":"RODRIGUEZ JIMENEZ MARIA ESTEFANIA","100017243":"SANCHEZ GONZALEZ CAMILA AMEYALTZIN","100017751":"VARGAS CASTILLO INES","100018135":"VARGAS TIRSO MARICARMEN","100016403":"AGUILA CADENA ADALIF ANGELLIQUE","100016666":"AGUILAR MIXCOATL ANDRES GABRIEL","100015977":"ANGEL FLORES MARIA TERESA","100016587":"ARIZA AGUILAR DANNA","100016046":"ARROYO GIL MELISSA","100016190":"AVALOS OLIVAS OLGA MABEL","100016786":"CONTRERAS APANGO VALERIA","100016972":"CORTES DOMINGUEZ SAYURI ALONDRA","100016254":"CORTEZ CALDERON KRIZIA NICOLE","100016271":"DEGANTE SILVERIO AXEL","100016352":"FERNANDEZ ITURRIAGA NICOLAS","100016393":"FLORES MANZANO MARYFER","100016664":"FLORES SALAZAR LUIS RICARDO","100016663":"JARQUIN FLORES ESMERALDA","100016570":"LUNA MARCOS JOSE MARIA","100016493":"MOO VASQUEZ CARLOS ARIEL","100016969":"PERALTA GONZALEZ ALEXANDRA","100016181":"ROMERO NUÑEZ DIEGO GAEL","100015510":"AGUILAR ARELLANO YARIMETH","100015705":"AGUILAR HIDALGO EDGAR MANUEL","100014782":"AGUILAR PEREZ DULCE ARANZA","100015254":"COYOTL SOTO JESUS EDUARDO","100015436":"GONZALEZ TOXTLE ADILENE","100015146":"LEAL GOMEZ KAREN JANINA","100015789":"LOPEZ ANDRADE IRVIN DANIEL","100015504":"MARTINEZ ROMERO GUADALUPE","100015161":"MORALES ROJAS XIMENA","100014091":"MUÑOZ CASTAÑEDA JOSE MANUEL","100015332":"OREA ZARATE MARIANA","100015612":"OSORIO GARCIA JESSICA EMILY","100015244":"PEREZ VAZQUEZ RICARDO","100015601":"SANCHEZ LEON ANIEFH MICHELLE","100015166":"TEHUITZIL RODRIGUEZ YAEL","100015112":"TELLEZ FLORES FRANCISCO JAVIER","100015093":"TORNEZ ROQUE MILKA GUADALUPE","100014418":"AGUILAR MORALES JUARYTH","100014714":"ANDRADE REYES ALEJANDRO","100015048":"ANDRADE VELAZQUEZ MELISA","100014785":"BRAVO RAMIREZ SUANY YARLETH","100014786":"CAMACHO HERNANDEZ JOSE LUIS","100014094":"CASTAÑEDA CRUZ ALBERTO","100014439":"COYOTL HUANETL DAVID","100014290":"FLORES FIGUEROA YARET CELIA","100014235":"LOPEZ GARCIA PEDRO ANDRES","100014275":"MARTINEZ MARTINEZ REGINA","100014715":"POTENCIANO ROMERO URIEL DE JESUS","100014115":"VELAZQUEZ MOYOTL ANA JOLETTE","100013212":"ALTAMIRA GUEVARA ALEX ALBERTO","100013240":"CUAZITL VELASCO MIRIAM ALONDRA","100015586":"ALVARO GONZALEZ REY DAVID","100015408":"CORTES CASTRO PATRICIA","100015247":"GARCIA MENESES KENIA","100015389":"GONZALEZ BAUTISTA MARIANNE","100015301":"JERONIMO GONZALEZ ALY ESTEPHANY","100015303":"LOPEZ MARTINEZ LORELEI JANETH","100015212":"MAGAÑA DE JESUS JAZMIN ARLETTE","100015383":"MARTINEZ HERNANDEZ ANA MONTSERRAT","100015809":"PAEZ DE LEON IAN CARLOS","100015419":"PEREZ HUACHINA YURIDIA","100015515":"PORRAS PROMOTOR ANA PAOLA","100015243":"SALAMA AGUILAR EMILIO","100015442":"VAZQUEZ RAMIREZ MILDRE AZUCENA","100014672":"AGUILAR JUAREZ DANIEL","100014724":"ARCE FLORES ALDO","100014053":"BORJA SANCHEZ RICARDO SAID","100014127":"CAMACHO MACIN ARACELI","100014114":"DE MERCED HUERTA ALONDRA","100014274":"GARCIA ALVAREZ ERENDIRA SAMANTA","100014277":"GARCIA LOPEZ DANNA PAOLA","100014658":"HERNANDEZ RODRIGUEZ NADIA","100014109":"NIEMBRO ROJAS COVADONGA","100014456":"NIÑO MARTINEZ JOSE MANUEL","100014554":"RAMIREZ PALACIOS JAFET","100017960":"BAEZ MOXO GERARDO ALEXIS","100018143":"BALTAZAR TAPIA CAMILA","100017495":"CABAÑAS SANCHEZ CARLOS","100017538":"DIRCIO VENEGAS CRISTIAN EMMANUEL","100017890":"ESPINOSA HERNANDEZ KARLA DANIELA","100017896":"ESQUIVEL LOPEZ MARIA LIZBETH","100017738":"FLORES BARBOSA MIA ANDREA","100018159":"FLORES ZEFERINO GUADALUPE","100017492":"FUENTECILLA SANTIAGO MINERVA","100017424":"JIMENEZ HERNANDEZ JUAN MANUEL","100017568":"JIMENEZ MELENDEZ JULISSA","100017733":"JIMENEZ MELQUIADES ALARICK ISAI","100018163":"JUAREZ REYES MOISES","100017418":"LOYOLA ORTEGA NURI GUADALUPE","100018146":"MARTINEZ LUNA EDITH","100018173":"MONROY ZAMORA JOSUE GERMAN","100017529":"MORENO BRISEÑO CINTHIA","100018001":"OLIVAREZ GARCIA AXCEL","100017756":"RAMIREZ DAMAS VALERY HAIDE","100017660":"REYES CELAYA ISAMAR","100017668":"ROJAS GARCIA AQUETZALIN","100018183":"RUIZ LIMA ESTEFANIA","100018160":"SANTAMARIA SORIANO DULCE MARIELA","100017952":"SANTOS GUTIERREZ DULCE VALERIA","100018051":"SEGURA LEON VALERIA MICHEL","100018065":"TENIZA MOSON ARANZA BELEM","100018092":"VÁZQUEZ MONTIEL VALERIA","100016789":"AMADOR BELLO BRANDON","100016387":"BECERRA LOEZA MARIAN ANGELA","100016593":"BLANCO CASTELLANOS KARLA LUPITA","100016950":"BRUNO ORTIZ DIANA LAURA","100016150":"CABRERA CRUZ PILAR","100016402":"CHARRO QUINTANA MAYREL","100016992":"CORDERO MONTIEL GALIA","100016349":"CRESPO DE LA CRUZ LEHOMAR","100016650":"GARCIA GARCIA DIEGO ENRIQUE","100016958":"HERNANDEZ HERRERA AUSTIN ALEJANDRO","100016398":"HERNANDEZ LUIS EMMA PAOLA","100016673":"LOPEZ PEREZ MIGUEL ANGEL","100016136":"LUNA ORTEGA SANDY","100016917":"ORIZAVA RIVERA OLIVER","100016500":"PEREZ VAZQUEZ FABIAN","100016784":"RAMOS MENDEZ LIZBETH","100016702":"ROJAS FLORES ABIGAIL","100016872":"ROJAS SANCHEZ JOSE MANUEL","100016782":"SANCHEZ CASTILLO DAFNE SARAI","100016923":"SANCHEZ SAN MARTIN JUAN YARED","100016754":"SANTOS ROJAS JOSELIN","100016874":"SAUCEDO DELGADO ASHLEY"};

/* --- UTILS --- */
function fmtMoney(n) { return "$" + n.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

/* --- CONFIG --- */
const MAX_DAYS = 7;
const INITIAL_CASH = 1000000;

const assetsDB = [
    { 
        id: 'ipc', name: 'IPC México', type: 'Índice', base: 54000, 
        desc: "El Índice de Precios y Cotizaciones (IPC) es el principal indicador de la Bolsa Mexicana de Valores. Mide el comportamiento de las 35 empresas más líquidas y capitalizadas del país. Si crees que la economía mexicana crecerá, este es tu activo base.", 
        tip: "En años electorales o reformas constitucionales, suele mostrar alta volatilidad. Ideal para perfiles moderados.",
        risk: "Medio", vol: "Media", hist: [1, 1.01, 1.005, 0.98, 0.95, 0.96, 0.99] 
    },
    { 
        id: 'spx', name: 'S&P 500', type: 'Índice', base: 9500, 
        desc: "El Standard & Poor's 500 sigue a las 500 empresas más grandes de EE.UU. Es el termómetro de la economía global. Históricamente, siempre ha tendido al alza en plazos largos (10+ años), pero a corto plazo sufre con las tasas de la Fed.", 
        tip: "La apuesta más segura en renta variable a largo plazo. 'Nunca apuestes contra América' dicen por ahí.",
        risk: "Medio", vol: "Baja", hist: [1, 1.02, 1.03, 1.01, 0.90, 0.92, 0.95] 
    },
    { 
        id: 'usd', name: 'Dólar (USD)', type: 'Divisa', base: 19.80, 
        desc: "El billete verde es la moneda de reserva mundial. En México, funciona como un activo de refugio: cuando hay miedo, crisis o incertidumbre local, el dinero inteligente corre hacia el dólar.", 
        tip: "Funciona como un seguro de vida para tu portafolio. Si todo lo demás cae, el dólar suele subir.",
        risk: "Bajo", vol: "Baja", hist: [1, 1.01, 1.03, 1.05, 1.10, 1.08, 1.07] 
    },
    { 
        id: 'nvda', name: 'NVIDIA', type: 'Acción', base: 2800, 
        desc: "El rey indiscutible de los chips de Inteligencia Artificial. Actualmente la empresa más importante del planeta, pero con una valoración tan alta que cualquier mala noticia podría causar un desplome masivo.", 
        tip: "Puede hacerte rico o pobre en una semana. No apto para cardíacos. Es pura especulación tecnológica.",
        risk: "Alto", vol: "Muy Alta", hist: [1, 1.05, 1.12, 1.15, 0.70, 0.80, 0.95] 
    },
    { 
        id: 'amzn', name: 'Amazon', type: 'Acción', base: 3200, 
        desc: "No solo es una tienda online; es dueño de la mitad de internet gracias a sus servidores (AWS). Una máquina de generar flujo de efectivo con márgenes muy estables y dominio logístico total.", 
        tip: "Suele subir en temporadas de compras como el Black Friday o Navidad.",
        risk: "Medio", vol: "Media", hist: [1, 0.98, 0.99, 1.02, 1.04, 1.06, 1.10] 
    },
    { 
        id: 'googl', name: 'Google', type: 'Acción', base: 3400, 
        desc: "Alphabet Inc. tiene un monopolio casi total en búsquedas y publicidad digital. Genera dinero masivamente, pero enfrenta riesgos regulatorios constantes por leyes antimonopolio.", 
        tip: "Si no sabes qué comprar, Google rara vez falla a largo plazo. Es el gigante silencioso.",
        risk: "Medio", vol: "Media", hist: [1, 1.01, 1.01, 1.02, 0.99, 1.01, 1.03] 
    },
    { 
        id: 'tsla', name: 'Tesla', type: 'Acción', base: 4100, 
        desc: "Más que una empresa de coches, es una apuesta sobre el futuro de la energía y la robótica. Su precio se mueve más por los tuits de Elon Musk y promesas futuras que por sus ventas actuales.", 
        tip: "Es un culto, no una empresa. Cuidado con la volatilidad extrema.",
        risk: "Muy Alto", vol: "Extrema", hist: [1, 1.05, 1.02, 0.95, 0.90, 0.85, 1.15] 
    },
    { 
        id: 'gold', name: 'Oro', type: 'Commodity', base: 35000, 
        desc: "El refugio milenario. No paga intereses ni dividendos, ni produce nada, pero mantiene su poder adquisitivo cuando el dinero fiduciario pierde valor. Es la protección definitiva contra el caos.", 
        tip: "Cómpralo si crees que viene el apocalipsis financiero o la Tercera Guerra Mundial.",
        risk: "Bajo", vol: "Baja", hist: [1, 1.01, 1.02, 1.04, 1.05, 1.06, 1.07] 
    },
    { 
        id: 'oil', name: 'Petróleo WTI', type: 'Commodity', base: 1400, 
        desc: "El West Texas Intermediate es la referencia del crudo en América. Su precio depende totalmente de la geopolítica, guerras en Medio Oriente y decisiones del cártel de la OPEP.", 
        tip: "Sube rápido cuando hay rumores de guerra. Baja cuando la economía mundial se frena.",
        risk: "Alto", vol: "Alta", hist: [1, 1.05, 1.10, 1.15, 1.00, 0.90, 0.85] 
    },
    { 
        id: 'pemex', name: 'Bonos PEMEX', type: 'Obligación', base: 100, 
        desc: "Deuda de la petrolera más endeudada del mundo. Ofrece rendimientos altísimos (premio por riesgo) porque los inversionistas temen que no pueda pagar sin ayuda del gobierno.", 
        tip: "¿Confías en que el gobierno la rescatará siempre? Si sí, es dinero fácil. Si no, es basura.",
        risk: "Alto", vol: "Media", hist: [1, 0.99, 0.98, 0.95, 0.90, 0.85, 0.88] 
    },
    { 
        id: 'bimbo', name: 'Cert. BIMBO', type: 'Obligación', base: 105, 
        desc: "Deuda corporativa de la panificadora más grande del mundo. Extremadamente estable. En tiempos de crisis, la gente deja de comprar coches, pero sigue comprando pan.", 
        tip: "Rendimiento bajo pero seguro. Ideal para dormir tranquilo por las noches.",
        risk: "Bajo", vol: "Baja", hist: [1, 1.001, 1.002, 1.003, 1.004, 1.005, 1.006] 
    },
    { 
        id: 'cetes', name: 'CETES 28', type: 'Bono Gov', base: 10, 
        desc: "Certificados de la Tesorería. Deuda del Gobierno Federal Mexicano. Se considera la inversión 'Libre de Riesgo' en pesos. Tienen una tasa fija conocida desde el inicio.", 
        tip: "Si el gobierno deja de pagar esto, preocúpate por conseguir comida enlatada, no por tu dinero.",
        risk: "Nulo", vol: "Nula", hist: [1, 1.002, 1.004, 1.006, 1.008, 1.010, 1.012] 
    },
    { 
        id: 'btc', name: 'Bitcoin', type: 'Cripto', base: 1300000, 
        desc: "Oro digital descentralizado e incensurable. Su oferta es limitada matemáticamente. Puede valer un millón mañana o cero si se prohíbe globalmente. Pura ley de oferta y demanda.", 
        tip: "Solo mete el dinero que estés dispuesto a perder totalmente. High Risk, High Reward.",
        risk: "Extremo", vol: "Extrema", hist: [1, 1.10, 1.20, 0.90, 0.85, 1.25, 1.40] 
    }
];

const startScenarios = [
    { fin: ["Bolsa Mexicana toca máximos históricos esta mañana.", "NVIDIA lidera el rally global con nuevas ganancias."], eco: ["Confianza del consumidor alcanza nivel récord.", "El sector tecnológico se muestra imparable."], hint: "El mercado está eufórico. Aprovecha la tendencia alcista." },
    { fin: ["Temores de recesión en EE.UU. tiran los mercados.", "Inversores buscan refugio en bonos y oro."], eco: ["PIB global muestra signos claros de desaceleración.", "Alerta roja en el sector de construcción."], hint: "Tiempos inciertos. Busca activos seguros como Bonos o Dólares." },
    { fin: ["Bitcoin rompe barreras de resistencia importantes.", "Fiebre especulativa por la Inteligencia Artificial."], eco: ["Analistas debaten: ¿Nueva burbuja punto com?", "Alta volatilidad esperada en criptoactivos."], hint: "Alto riesgo, alta recompensa. Cripto promete." }
];
const fixedNews = [ null, null,
    { fin: ["Rumores de regulación tecnológica en la Unión Europea.", "La deuda de PEMEX preocupa a las calificadoras."], eco: ["La UE prepara una multa millonaria para NVIDIA.", "Incertidumbre cambiaria afecta al peso."], hint: "Cuidado con NVIDIA y PEMEX. Hay ruido negativo." },
    { fin: ["La inflación repunta ligeramente en el último reporte.", "Se espera que las tasas de interés se mantengan altas."], eco: ["Banxico se mantiene firme con su política monetaria.", "BIMBO reporta solidez financiera ante la crisis."], hint: "En entornos de tasas altas, la deuda corporativa sólida es refugio." },
    { fin: ["¡ALERTA ROJA! NVIDIA es investigada por fraude contable.", "El S&P 500 cae con fuerza tras la noticia."], eco: ["Pánico vendedor se apodera de Wall Street hoy.", "Inversores liquidan posiciones masivamente."], hint: "¡VENDE RIESGO! El mercado está colapsando. Busca liquidez." },
    { fin: ["Los mercados intentan estabilizarse tras el crash.", "El dólar se dispara como activo de refugio."], eco: ["Cazadores de ofertas empiezan a comprar acciones baratas.", "NVIDIA toca sus mínimos anuales."], hint: "A veces, tras el pánico viene el rebote. ¿Te atreves a comprar barato?" },
    { fin: ["El gobierno anuncia plan de rescate para la deuda.", "Amazon sorprende con resultados trimestrales positivos."], eco: ["Hacienda recompra bonos para dar confianza.", "El consumo interno se muestra más fuerte de lo esperado."], hint: "El sector consumo (Amazon) y Cripto lideran la recuperación." },
    { fin: ["Cierre de ejercicio fiscal. Se recomienda cautela.", "Resultados mixtos al cierre de la jornada."], eco: ["Fin del ciclo bursátil. Es hora de hacer balances.", "Expectativa de cierre tranquila."], hint: "Asegura ganancias. No arriesgues hoy. Cierra libros." }
];

const hustles = [
    { title: "Lote de Vapes", desc: "Un contacto vende mercancía china 'gris' a precio de remate.", cost: 50000, riskText: "La policía confiscó la mercancía." },
    { title: "Puesto de Tacos", desc: "Traspaso de local frente a la universidad.", cost: 100000, riskText: "Clausurado por salubridad." },
    { title: "Préstamo Personal", desc: "Un compañero necesita dinero urgente. Pagaré firmado.", cost: 20000, riskText: "El compañero se dio de baja y desapareció." },
    { title: "NFTs de Monos", desc: "Colección de arte digital. Dicen que subirá.", cost: 10000, riskText: "El proyecto era una estafa (Rug Pull)." }
];

let gameState = {
    id: "", name: "", day: 1, cash: INITIAL_CASH, portfolio: {},
    bypassed: 0, blackSwans: {}, narrativeId: 0,
    expertConsulted: false, loan: { bank: null, amount: 0, rate: 0 }, hustleDone: false
};

assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
let currentNewsSource = 'fin'; 

/* --- INTERFAZ --- */
function toggleLoginMode(mode) {
    const btnNew = document.getElementById('tabNew'), btnLoad = document.getElementById('tabLoad'), formNew = document.getElementById('newGameForm'), formLoad = document.getElementById('loadGameForm');
    if(mode === 'new') { formNew.classList.remove('hidden'); formLoad.classList.add('hidden'); btnNew.classList.replace('text-gray-400', 'text-blue-900'); btnNew.classList.add('border-blue-900'); btnLoad.classList.replace('text-blue-900', 'text-gray-400'); btnLoad.classList.remove('border-blue-900'); }
    else { formNew.classList.add('hidden'); formLoad.classList.remove('hidden'); btnLoad.classList.replace('text-gray-400', 'text-blue-900'); btnLoad.classList.add('border-blue-900'); btnNew.classList.replace('text-blue-900', 'text-gray-400'); btnNew.classList.remove('border-blue-900'); }
}

function startSequence() {
    const id = document.getElementById('studentId').value.trim();
    if(!id) return alert("Ingresa tu matrícula");
    const studentName = STUDENT_DB[id];
    if(!studentName) return alert("⛔ ACCESO DENEGADO\nMatrícula no autorizada.");

    gameState.id = id;
    gameState.name = studentName;
    gameState.day = 1;
    gameState.cash = INITIAL_CASH;
    gameState.portfolio = {};
    assetsDB.forEach(a => gameState.portfolio[a.id] = 0);
    gameState.narrativeId = Math.floor(Math.random() * 3);
    gameState.lastSaveTime = Date.now(); // Reset time check on new game
    
    if(document.getElementById('guideCheck').checked) document.querySelectorAll('.help-icon').forEach(el => el.classList.remove('hidden'));
    
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('gameSection').classList.remove('hidden');
    renderGame();
}

/* --- GAME LOGIC --- */
function renderGame() {
    document.getElementById('operatorNameDisplay').innerText = gameState.name;
    document.getElementById('operatorIdDisplay').innerText = gameState.id;
    document.getElementById('displayDay').innerText = `Día ${gameState.day} / ${MAX_DAYS}`;
    document.getElementById('displayCash').innerText = fmtMoney(gameState.cash);
    
    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0) * getPrice(a, gameState.day));
    const netWorth = gameState.cash + portVal - gameState.loan.amount;
    
    document.getElementById('displayPortfolioVal').innerText = fmtMoney(portVal);
    document.getElementById('displayNetWorth').innerText = fmtMoney(netWorth);

    // Expert Status
    const btnExp = document.getElementById('btnExpert');
    if(gameState.expertConsulted) {
        btnExp.classList.add('opacity-50', 'cursor-not-allowed');
        btnExp.innerHTML = `<span><i class="fas fa-check"></i> Ya Consultado</span>`;
    } else {
        btnExp.classList.remove('opacity-50', 'cursor-not-allowed');
        btnExp.innerHTML = `<span><i class="fas fa-user-tie"></i> Consultar Analista</span><span class="text-[9px] bg-gray-300 px-1 rounded">Varios</span>`;
    }

    // Loan Status
    if(gameState.loan.amount > 0) { document.getElementById('btnLoan').classList.add('hidden'); document.getElementById('loanStatus').classList.remove('hidden'); }
    else { document.getElementById('btnLoan').classList.remove('hidden'); document.getElementById('loanStatus').classList.add('hidden'); }

    // Hustle Status
    if(gameState.hustleDone) { document.getElementById('btnHustle').classList.add('opacity-50', 'cursor-not-allowed'); document.getElementById('hustleStatus').classList.remove('hidden'); }
    else { document.getElementById('btnHustle').classList.remove('opacity-50', 'cursor-not-allowed'); document.getElementById('hustleStatus').classList.add('hidden'); }

    renderNews(); renderTable();
}

function renderTable() {
    const tbody = document.getElementById('marketTableBody'); tbody.innerHTML = '';
    assetsDB.forEach(a => {
        const price = getPrice(a, gameState.day);
        const qty = gameState.portfolio[a.id] || 0;
        let status = '<span class="text-gray-400">▬</span>';
        const swanMult = (gameState.blackSwans && gameState.blackSwans[a.id]) !== undefined ? gameState.blackSwans[a.id] : null;
        
        if (swanMult !== null) {
            if(swanMult > 1.2) status = '🚀 MOON';
            else if (swanMult < 0.1) status = '💀 CRASH';
            else if (swanMult < 1) status = '🔻 DOWN';
        } else if(gameState.day > 1) {
            const prev = getPrice(a, gameState.day - 1);
            const change = (price - prev) / prev;
            if(change > 0.03) status = '<span class="text-green-600 font-bold">▲▲</span>';
            else if(change > 0) status = '<span class="text-green-500">▲</span>';
            else if(change < -0.03) status = '<span class="text-red-600 font-bold">▼▼</span>';
            else if(change < 0) status = '<span class="text-red-500">▼</span>';
        }

        const tr = document.createElement('tr');
        tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-100";
        tr.innerHTML = `
            <td class="px-3 py-3 font-bold text-blue-900 text-xs">${a.name}</td>
            <td class="px-3 py-3 text-center"><button onclick="showInfo('${a.id}')" class="text-[9px] bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 py-1 rounded">FICHA</button></td>
            <td class="px-3 py-3 text-center text-xs font-bold">${status}</td>
            <td class="px-3 py-3 text-right font-mono text-xs text-gray-700 font-bold">${fmtMoney(price)}</td>
            <td class="px-3 py-3 text-center text-xs text-gray-500">${qty.toFixed(2)}</td>
            <td class="px-3 py-3 text-center">
                <button onclick="openTrade('${a.id}')" class="bg-blue-900 hover:bg-blue-800 text-white text-[10px] px-3 py-1 rounded font-bold shadow" ${swanMult !== null && swanMult < 0.1 ? 'disabled class="opacity-50"' : ''}>OPERAR</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function getPrice(asset, day) {
    if(day === 0) return asset.base;
    let multiplier = 1; if(gameState.blackSwans && gameState.blackSwans[asset.id] !== undefined) multiplier = gameState.blackSwans[asset.id];
    let idx = day - 1; if(idx >= asset.hist.length) idx = asset.hist.length - 1;
    return asset.base * asset.hist[idx] * multiplier;
}

function renderNews() {
    let data; if(gameState.day === 1) data = startScenarios[gameState.narrativeId || 0]; else data = fixedNews[gameState.day] || { fin:[], eco:[], hint:"" };
    const items = currentNewsSource === 'fin' ? data.fin : data.eco; const title = currentNewsSource === 'fin' ? 'EL FINANCIERO' : 'EL ECONOMISTA'; const color = currentNewsSource === 'fin' ? 'text-orange-700' : 'text-blue-900';
    document.getElementById('newsTitle').innerText = title; document.getElementById('newsTitle').className = `headline-font font-black text-2xl leading-none ${color}`;
    const feed = document.getElementById('newsFeed'); feed.innerHTML = '';
    items.forEach(txt => { const borderCol = title.includes('FINANCIERO') ? 'border-orange-400' : 'border-blue-900'; feed.innerHTML += `<div class="border-l-4 ${borderCol} pl-3 py-1"><p class="font-serif font-bold text-gray-800 text-xs leading-tight">${txt}</p></div>`; });
}
function toggleNewsSource() { currentNewsSource = currentNewsSource === 'fin' ? 'eco' : 'fin'; renderNews(); }

/* --- MODALS --- */
function showInfo(id) {
    const a = assetsDB.find(x => x.id === id);
    document.getElementById('infoTitle').innerText = a.name;
    document.getElementById('infoDesc').innerText = a.desc;
    document.getElementById('infoType').innerText = a.type;
    document.getElementById('infoRisk').innerText = a.risk;
    document.getElementById('infoVol').innerText = a.vol; 
    document.getElementById('infoTip').innerText = a.tip; 
    document.getElementById('infoModal').classList.remove('hidden'); document.getElementById('infoModal').classList.add('flex');
}

function openExpertModal() {
    if(gameState.expertConsulted) return alert("Ya has consultado a un experto hoy.");
    document.getElementById('expertModal').classList.remove('hidden'); document.getElementById('expertModal').classList.add('flex');
}

function buyAdvice(type) {
    let cost = 0;
    if(type === 'junior') cost = 500;
    else if(type === 'senior') cost = 3000;
    else if(type === 'insider') cost = 10000;

    if(gameState.cash < cost) return alert("Saldo insuficiente.");
    if(!confirm(`¿Contratar servicio por ${fmtMoney(cost)}?`)) return;

    gameState.cash -= cost;
    gameState.expertConsulted = true;
    document.getElementById('expertModal').classList.add('hidden');
    
    // Advice Logic
    let hint = "Sin datos claros.";
    if(gameState.day < MAX_DAYS) {
        const nextData = fixedNews[gameState.day + 1];
        if(nextData) hint = nextData.hint;
    }
    
    // Accuracy RNG
    let msg = hint;
    if(type === 'junior' && Math.random() > 0.5) msg = "El mercado parece tranquilo... creo.";
    if(type === 'senior' && Math.random() > 0.8) msg = "Se observan señales mixtas.";
    
    const resBox = document.getElementById('expertResult');
    resBox.innerText = `CONSEJO: "${msg}"`;
    resBox.classList.remove('hidden');
    renderGame();
}

function openLoanModal() { document.getElementById('loanModal').classList.remove('hidden'); }
function selectLoan(bank) {
    let amount=0, rate=0;
    if(bank==='azteca'){amount=300000;rate=0.04;} else if(bank==='santander'){amount=500000;rate=0.025;} else if(bank==='bbva'){
        let p=0;assetsDB.forEach(a=>p+=(gameState.portfolio[a.id]||0)*getPrice(a,gameState.day));
        if((gameState.cash+p)<1200000 && Math.random() > 0.3) return alert("Solicitud rechazada por riesgo.");
        amount=1000000;rate=0.012;
    }
    if(confirm(`¿Contratar crédito?\nRecibes: ${fmtMoney(amount)}\nInterés Diario: ${(rate*100)}%`)) { gameState.loan={bank,amount,rate}; gameState.cash+=amount; document.getElementById('loanModal').classList.add('hidden'); renderGame(); }
}
function payLoan() {
    if(gameState.loan.amount <= 0) return;
    if(gameState.cash < gameState.loan.amount) return alert("No tienes suficiente liquidez para liquidar la deuda.");
    if(confirm(`¿Liquidar deuda de ${fmtMoney(gameState.loan.amount)}?`)) {
        gameState.cash -= gameState.loan.amount;
        gameState.loan = { bank: null, amount: 0, rate: 0 };
        renderGame();
    }
}

function openHustleModal() { if(gameState.hustleDone) return; const hustle = hustles[Math.floor(Math.random() * hustles.length)]; document.getElementById('hustleTitle').innerText = hustle.title; document.getElementById('hustleDesc').innerText = hustle.desc; document.getElementById('hustleCost').innerText = fmtMoney(hustle.cost); document.getElementById('hustleModal').classList.remove('hidden'); gameState.tempHustle = hustle; }
function executeHustle() {
    const h = gameState.tempHustle; if(!h || gameState.cash < h.cost) return alert("Sin fondos.");
    gameState.cash -= h.cost; document.getElementById('hustleModal').classList.add('hidden'); gameState.hustleDone = true;
    // RNG outcome
    if(Math.random() > 0.5) { 
        let profit = h.cost * (1.5 + Math.random()); 
        gameState.cash += profit; 
        alert(`🎉 ¡ÉXITO! Ganaste ${fmtMoney(profit - h.cost)} netos.`); 
    } else { 
        alert(`📉 FRACASO. ${h.riskText} Perdiste la inversión.`); 
    }
    renderGame();
}

/* --- TRADE --- */
let currTradeId = null, tradeMode = 'buy';
function openTrade(id) { 
    currTradeId = id; tradeMode = 'buy'; 
    const a = assetsDB.find(x => x.id === id); 
    const p = getPrice(a, gameState.day); 
    const owned = gameState.portfolio[id] || 0;
    
    document.getElementById('tradeModal').classList.remove('hidden'); 
    document.getElementById('tradeModal').classList.add('flex'); 
    document.getElementById('tradeAssetName').innerText = a.name; 
    document.getElementById('tradeAssetPrice').innerText = fmtMoney(p); 
    document.getElementById('tradeOwnedQty').innerText = owned.toFixed(4);
    document.getElementById('tradeOwnedVal').innerText = fmtMoney(owned * p);
    document.getElementById('tradeAmount').value = ''; 
    setTradeMode('buy'); 
}
function setTradeMode(m) { tradeMode = m; const bB = document.getElementById('btnModeBuy'), bS = document.getElementById('btnModeSell'); if(m==='buy') { bB.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white"; bS.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500"; } else { bS.className="flex-1 py-1 rounded text-xs font-bold bg-blue-900 text-white"; bB.className="flex-1 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500"; } }
function closeTradeModal() { document.getElementById('tradeModal').classList.add('hidden'); document.getElementById('tradeModal').classList.remove('flex'); }
function executeTrade() {
    const amt = parseFloat(document.getElementById('tradeAmount').value); if(!amt || amt<=0) return;
    const a = assetsDB.find(x => x.id === currTradeId); const p = getPrice(a, gameState.day);
    if(tradeMode === 'buy') { if(amt > gameState.cash) return alert("Liquidez insuficiente."); gameState.cash -= amt; if(!gameState.portfolio[currTradeId]) gameState.portfolio[currTradeId] = 0; gameState.portfolio[currTradeId] += amt/p; }
    else { const val = (gameState.portfolio[currTradeId]||0)*p; if(amt > val+1) return alert("Posición insuficiente."); if(Math.abs(amt-val)<10) { gameState.cash+=val; gameState.portfolio[currTradeId]=0; } else { gameState.cash+=amt; gameState.portfolio[currTradeId]-=amt/p; } }
    closeTradeModal(); renderGame();
}

/* --- END DAY --- */
function endDay() {
    if(!confirm("¿Cerrar libros del día?")) return;
    let loanMsg = "";
    if(gameState.loan.amount > 0) { const int = gameState.loan.amount * gameState.loan.rate; gameState.cash -= int; loanMsg = `Intereses cobrados: -${fmtMoney(int)}`; }
    
    let portVal = 0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, gameState.day));
    const todayNet = gameState.cash + portVal - gameState.loan.amount;
    const roi = (todayNet - INITIAL_CASH);
    
    // Oregon Trail Style Visuals
    let art = "😐"; let colorClass = "text-gray-500"; let irony = "";
    if(roi > 100000) { art = "🚀"; colorClass="text-green-400"; irony = "El mercado te ama (por ahora)."; }
    else if(roi > 0) { art = "📈"; colorClass="text-green-600"; irony = "Sobreviviste un día más."; }
    else if(roi < -100000) { art = "💀"; colorClass="text-red-600"; irony = "Tu cuenta bancaria llora sangre."; }
    else { art = "📉"; colorClass="text-yellow-600"; irony = "Vas perdiendo hasta la dignidad."; }

    document.getElementById('pixelArtHeader').innerHTML = art;
    document.getElementById('endDayTitle').className = `text-xl font-bold mb-2 pixel-font text-xs leading-relaxed ${colorClass}`;
    document.getElementById('endDayMsg').innerText = roi >= 0 ? `Ganancia acumulada: +${fmtMoney(roi)}` : `Pérdida acumulada: ${fmtMoney(roi)}`;
    document.getElementById('endDayIrony').innerText = irony;
    document.getElementById('daySummary').innerText = loanMsg;

    if(gameState.day >= MAX_DAYS) { showResults(); return; }
    
    // PREPARE NEXT DAY
    let nextState = JSON.parse(JSON.stringify(gameState)); 
    nextState.day++; nextState.expertConsulted = false; nextState.hustleDone = false;
    delete nextState.name; // Don't save name in token
    nextState.lastSaveTime = Date.now(); // Mark time

    const jsonStr = JSON.stringify(nextState);
    const code = "UDAL-" + utf8_to_b64(jsonStr).split('').reverse().join('');
    document.getElementById('generatedCode').innerText = code; 
    document.getElementById('saveModal').classList.remove('hidden'); 
    document.getElementById('saveModal').classList.add('flex');
}

/* --- SAVE/LOAD --- */
function showResults() {
    document.getElementById('gameSection').classList.add('hidden'); document.getElementById('resultsSection').classList.remove('hidden'); document.getElementById('resultsSection').classList.add('flex');
    let portVal=0; assetsDB.forEach(a => portVal += (gameState.portfolio[a.id]||0)*getPrice(a, MAX_DAYS));
    const finalVal = gameState.cash + portVal - gameState.loan.amount; const roi = ((finalVal - INITIAL_CASH) / INITIAL_CASH) * 100;
    document.getElementById('finalNetWorth').innerText = fmtMoney(finalVal); document.getElementById('finalROI').innerText = roi.toFixed(2) + "%";
    const icon = document.getElementById('badgeIcon'), title = document.getElementById('rankTitle'), desc = document.getElementById('rankDesc');
    
    // Final Endings
    if(finalVal > 1200000) { 
        icon.innerHTML = '👑'; title.innerText = "MAGNATE"; desc.innerText = "Tu imperio sobrevivió a la peste."; 
    } else if (finalVal > 1050000) { 
        icon.innerHTML = '💼'; title.innerText = "EJECUTIVO"; desc.innerText = "Llegaste a la meta con ganancias."; 
    } else if (finalVal > 1000000) { 
        icon.innerHTML = '😐'; title.innerText = "SOBREVIVIENTE"; desc.innerText = "No perdiste la carreta, pero tampoco ganaste."; 
    } else { 
        icon.innerHTML = '💀'; title.innerText = "QUIEBRA"; desc.innerText = "Ahora vendes cursos de trading en TikTok."; 
    }
}

function loadGame() {
    let code = document.getElementById('saveCodeInput').value.trim().replace(/\s/g, '');
    let bypass = false; 
    
    // BYPASS CHECK (UDAL42-)
    if(code.startsWith("UDAL42-")) { 
        bypass = true; 
        code = "UDAL-" + code.substring(7); // Restore standard prefix for decoding
    }

    try {
        const encodedStr = code.replace("UDAL-","").split('').reverse().join('');
        const jsonStr = b64_to_utf8(encodedStr);
        const data = JSON.parse(jsonStr);
        if(!data.loan) data.loan = {amount:0, rate:0};
        
        // RECOVER NAME
        if(data.id && STUDENT_DB[data.id]) { data.name = STUDENT_DB[data.id]; } 
        else { data.name = "Desconocido"; }

        // TIME CHECK (If not bypassed)
        if(!bypass && data.day > 1 && data.lastSaveTime) {
            const hoursPassed = (Date.now() - data.lastSaveTime) / (1000 * 60 * 60);
            if(hoursPassed < 24) return alert(`Mercado cerrado. Debes esperar ${Math.ceil(24-hoursPassed)} horas más.`);
        }

        gameState = data;
        triggerBlackSwan();
        if(gameState.day > MAX_DAYS) showResults(); else {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            renderGame();
        }
    } catch(e) { alert("Token corrupto o formato inválido."); console.error(e); }
}

function copyCode() { navigator.clipboard.writeText(document.getElementById('generatedCode').innerText); alert("Copiado"); }

function checkTeacherLogin() { if(document.getElementById('teacherPwd').value === "udalintrader") { document.getElementById('teacherLoginModal').classList.add('hidden'); document.getElementById('teacherSection').classList.remove('hidden'); } }
function showTeacherLogin() { document.getElementById('teacherLoginModal').classList.remove('hidden'); document.getElementById('teacherLoginModal').classList.add('flex'); }
function verifyStudentCode() {
    let code = document.getElementById('teacherInput').value.trim().replace(/\s/g, ''); 
    if(code.startsWith("UDAL42-")) code = "UDAL-" + code.substring(7);
    
    try {
        const encodedStr = code.replace("UDAL-","").split('').reverse().join('');
        const jsonStr = b64_to_utf8(encodedStr);
        const data = JSON.parse(jsonStr);
        let studentName = (data.id && STUDENT_DB[data.id]) ? STUDENT_DB[data.id] : "Desconocido";
        let total = data.cash; assetsDB.forEach(a => { let idx = (data.day > 1) ? data.day - 2 : 0; total += (data.portfolio[a.id]||0) * (a.base * a.hist[idx]); });
        if(data.loan) total -= data.loan.amount;
        document.getElementById('teacherResult').classList.remove('hidden');
        document.getElementById('teacherResult').innerHTML = `<p class="font-bold text-blue-900">Alumno: ${studentName}</p><p class="text-xs text-gray-500">ID: ${data.id}</p><p>Día Actual: ${data.day}</p><p class="text-xl font-bold text-green-700">${fmtMoney(total)}</p>`;
    } catch(e){ alert("Error al leer token"); }
}
</script>
</body>
</html>